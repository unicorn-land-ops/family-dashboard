<!DOCTYPE html>
<html>
<head>
<title>Family Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html { background: #0a0a1a; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #0a0a1a 0%, #151530 100%);
    color: white;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}
.container {
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-rows: auto auto auto 1fr auto;
    padding: 20px;
    gap: 15px;
}
.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 5px;
}
.time {
    font-size: 10rem;
    font-weight: 300;
    color: #FFD700;
    letter-spacing: -3px;
    line-height: 1;
}
.date {
    font-size: 2.5rem;
    color: rgba(255,255,255,0.7);
    margin-left: 20px;
}
.weather-header {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(255,255,255,0.1);
    padding: 15px 25px;
    border-radius: 15px;
}
.weather-temp { font-size: 4rem; font-weight: 300; }
.weather-icon { font-size: 3rem; }
.sun-times {
    font-size: 1.4rem;
    color: rgba(255,255,255,0.7);
    text-align: right;
    line-height: 1.6;
}
.sun-times .sunrise { color: #FFD700; }
.sun-times .sunset { color: #FF8C42; }
.travel-banner {
    display: none;
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.25), rgba(0, 100, 200, 0.15));
    border: 2px solid rgba(0, 150, 255, 0.5);
    border-radius: 15px;
    padding: 15px 25px;
    font-size: 1.4rem;
    align-items: center;
    gap: 15px;
}
.travel-banner.active { display: flex; }
.travel-location { font-size: 1.8rem; font-weight: 600; color: #64B5F6; }
.travel-time { font-size: 2rem; font-weight: 300; color: #FFD700; font-family: monospace; }
.travel-sun { font-size: 1.2rem; color: rgba(255,255,255,0.7); }
.country-section {
    background: linear-gradient(135deg, rgba(155, 89, 182, 0.3), rgba(142, 68, 173, 0.2));
    border-radius: 15px;
    padding: 20px 25px;
    border: 2px solid rgba(155, 89, 182, 0.5);
}
.country-header {
    font-size: 1.2rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 12px;
}
.country-content {
    display: flex;
    align-items: center;
    gap: 25px;
}
.country-flag { font-size: 5rem; line-height: 1; }
.country-name { font-size: 2.5rem; font-weight: 700; color: #E8DAEF; }
.country-details { font-size: 1.4rem; color: rgba(255,255,255,0.9); margin-top: 8px; }
.country-dish { font-size: 1.3rem; color: rgba(255,255,255,0.7); margin-top: 4px; }

/* ASTROLOGY SECTION */
.astrology-section {
    padding: 10px 20px;
}
.astro-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.astro-line {
    font-size: 1.2rem;
    color: rgba(255,255,255,0.85);
    line-height: 1.4;
}
.astro-line .astro-symbol {
    font-size: 1.4rem;
    margin-right: 8px;
}

.main-content {
    display: flex;
    gap: 20px;
    overflow: hidden;
    min-height: 0;
}
.left-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
    overflow-y: auto;
}
.calendar-section {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 20px;
    border: 2px solid rgba(255,255,255,0.1);
}
.calendar-header {
    font-size: 1.5rem;
    font-weight: 600;
    color: rgba(255,255,255,0.6);
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 3px;
}
.calendar-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.day-row {
    display: flex;
    gap: 10px;
    padding: 12px 15px;
    background: rgba(255,255,255,0.06);
    border-radius: 10px;
    border-left: 4px solid transparent;
    min-height: 90px;
}
.day-row.today {
    background: rgba(255, 215, 0, 0.2);
    border-left-color: #FFD700;
}
.day-info {
    min-width: 120px;
    max-width: 140px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.day-name { font-size: 1.6rem; font-weight: 700; text-transform: uppercase; }
.day-name.today-label { color: #FFD700; }
.day-date { font-size: 1.4rem; color: rgba(255,255,255,0.7); font-weight: 500; }
.day-weather { font-size: 1.2rem; margin-top: 5px; }
.weather-icon-txt { font-size: 1.8rem; }
.day-events {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
    justify-content: center;
}
.event-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    font-size: 1.4rem;
}
.event-emojis { font-size: 1.6rem; min-width: 60px; }
.event-time {
    min-width: 55px;
    color: rgba(255,255,255,0.6);
    font-size: 1.3rem;
}
.event-title {
    flex: 1;
    line-height: 1.3;
}
.no-events { color: rgba(255,255,255,0.3); font-style: italic; font-size: 1.3rem; }
.event-no-school {
    background: rgba(0, 212, 170, 0.2);
    border: 1px solid rgba(0, 212, 170, 0.4);
    border-radius: 6px;
    padding: 2px 8px;
    color: #00D4AA;
    font-weight: 600;
}
.right-section {
    width: 38%;
    min-width: 380px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
}
.bvg-section {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 15px;
    border: 2px solid rgba(255,255,255,0.1);
}
.bvg-header { font-size: 1.4rem; margin-bottom: 15px; }
.bvg-logo {
    background: #FF3333;
    color: #0a0a1a;
    font-weight: 700;
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 1.2rem;
}
.bvg-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    background: rgba(255,255,255,0.08);
    border-radius: 10px;
    margin-bottom: 10px;
    font-size: 1.3rem;
}
.bvg-line {
    background: #FF3333;
    color: #0a0a1a;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 1.1rem;
}
.bvg-destination { flex: 1; margin-left: 15px; font-size: 1.3rem; }
.bvg-time { font-size: 1.6rem; font-weight: 600; color: #FFD700; }
.forecast-section {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 15px;
    border: 2px solid rgba(255,255,255,0.1);
}
.forecast-header {
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 12px;
}
.forecast-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    text-align: center;
}
.forecast-day {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 4px;
    border-radius: 8px;
}
.forecast-day.today-forecast {
    background: rgba(255, 215, 0, 0.15);
}
.forecast-day-name { font-size: 1rem; color: rgba(255,255,255,0.6); font-weight: 600; }
.forecast-day-icon { font-size: 1.6rem; }
.forecast-day-temps { font-size: 1rem; }
.forecast-high { color: #FFD700; font-weight: 600; }
.forecast-low { color: #6B9BFF; }
.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 10px;
    font-size: 0.9rem;
    color: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="display:flex;align-items:baseline;">
            <div class="time" id="clock">--:--</div>
            <div class="date" id="date">------</div>
        </div>
        <div style="display:flex;align-items:center;gap:20px;">
            <div class="sun-times" id="sun-times"></div>
            <div class="weather-header">
                <div class="weather-temp" id="current-temp">--</div>
                <div class="weather-icon" id="current-icon"></div>
            </div>
        </div>
    </div>
    <div class="travel-banner" id="travel-banner"></div>

    <div class="country-section">
        <div class="country-header">Country of the Day</div>
        <div class="country-content">
            <div class="country-flag" id="country-flag"></div>
            <div>
                <div class="country-name" id="country-name">Loading...</div>
                <div class="country-details" id="country-details">--</div>
                <div class="country-dish" id="country-dish"></div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="left-column">
            <div class="calendar-section">
                <div class="calendar-header">Next 7 Days</div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>

        <div class="right-section">
            <div class="bvg-section">
                <div class="bvg-header"><span class="bvg-logo">U2</span> Senefelderplatz</div>
                <div id="bvg-list"><div style="color:rgba(255,255,255,0.3);font-style:italic;padding:10px;">Loading transit...</div></div>
            </div>

            <div class="forecast-section">
                <div class="forecast-header">7-Day Forecast</div>
                <div class="forecast-grid" id="forecast-grid"></div>
            </div>
        </div>
    </div>

    <!-- ASTROLOGY - FULL WIDTH BOTTOM -->
    <div class="astrology-section">
        <div class="astro-list">
            <div class="astro-line"><span class="astro-symbol">&#9808;</span> <strong>Daddy</strong> &middot; <span id="astro-capricorn">Loading...</span></div>
            <div class="astro-line"><span class="astro-symbol">&#9808;</span> <strong>Wren</strong> &middot; <span id="astro-capricorn-2">Loading...</span></div>
            <div class="astro-line"><span class="astro-symbol">&#9809;</span> <strong>Ellis</strong> &middot; <span id="astro-aquarius">Loading...</span></div>
            <div class="astro-line"><span class="astro-symbol">&#9808;</span> <strong>Papa</strong> &middot; <span id="astro-sagittarius">Loading...</span></div>
        </div>
    </div>
</div>

<script>
// =============================================================================
// CONFIGURATION - Edit these values
// =============================================================================
const CONFIG = {
    // Google Apps Script calendar proxy URL (deploy as web app, paste URL here)
    calendarProxyUrl: '',

    // Weather: Berlin coordinates
    weatherLat: 52.5200,
    weatherLon: 13.4050,

    // BVG Transit: Senefelderplatz stop ID
    bvgStopId: '900110005',
    bvgLines: 'U2',

    // Family astrology signs
    familyAstro: {
        papa:  { name: 'Papa',  sign: 'sagittarius', symbol: '\u2650' },
        daddy: { name: 'Daddy', sign: 'capricorn',   symbol: '\u2651' },
        wren:  { name: 'Wren',  sign: 'capricorn',   symbol: '\u2651' },
        ellis: { name: 'Ellis', sign: 'aquarius',     symbol: '\u2652' }
    },

    // Calendar person emojis
    personEmojis: {
        'family': '\u{1F3E0}',
        'papa': '\u{1F951}',
        'daddy': '\u{1F36A}',
        'wren': '\u{1F338}',
        'ellis': '\u{1F96D}'
    },

    // Calendar IDs (for the Apps Script proxy)
    calendarIds: {
        family: '9gaocpaifjfdfd809s51vhteos@group.calendar.google.com',
        papa:   'joshua@masawa.fund',
        wren:   '0u0uevnmmhtb295sre9bftof98@group.calendar.google.com',
        ellis:  'p906t82tuhrdj60muv22euq3hs@group.calendar.google.com',
        daddy:  'scottculley@gmail.com'
    },

    // Travel detection timezones
    locationTimezones: {
        'munich': 'Europe/Berlin', 'new york': 'America/New_York', 'london': 'Europe/London',
        'paris': 'Europe/Paris', 'tokyo': 'Asia/Tokyo', 'singapore': 'Asia/Singapore',
        'sydney': 'Australia/Sydney', 'dubai': 'Asia/Dubai', 'east coast': 'America/New_York',
        'west coast': 'America/Los_Angeles', 'los angeles': 'America/Los_Angeles',
        'california': 'America/Los_Angeles', 'chicago': 'America/Chicago', 'boston': 'America/New_York'
    }
};

// =============================================================================
// CONSTANTS
// =============================================================================
const WEATHER_EMOJIS = {
    0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',
    51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üåßÔ∏è',61:'üåßÔ∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',
    71:'üå®Ô∏è',73:'üå®Ô∏è',75:'‚ùÑÔ∏è',80:'üåßÔ∏è',81:'üåßÔ∏è',82:'üåßÔ∏è',
    95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'
};
const DAY_ABBREV = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

const INTERESTING_COUNTRIES = [
    'ST','TV','BT','MV','LC','VC','KI','NR','PW','FM',
    'AD','LI','MC','SM','TO','MN','GE','AM','RW','SI','EE','LV','LT',
    'IS','FO','GL','SJ','ZA','NA','BW','ZM','ZW',
    'NP','BT','LA','MM','KH','CR','PA','GT','BZ','HN',
    'FJ','SB','VU','WS','TO'
];

const COUNTRY_FACTS = {
    'ST':'Straddles the equator in the Gulf of Guinea',
    'TV':'Fourth smallest country in the world',
    'BT':'Measures success by Gross National Happiness',
    'MV':'Lowest-lying country on Earth, avg 1.5m above sea level',
    'LC':'Named after Saint Lucy by French sailors',
    'VC':'Home to the oldest botanic gardens in the Western Hemisphere',
    'KI':'Spans all four hemispheres of the Earth',
    'NR':'Smallest island nation in the world',
    'PW':'Created the world\'s first shark sanctuary',
    'FM':'Contains ancient ruins of Nan Madol, the "Venice of the Pacific"',
    'AD':'Has no airport, railway, or seaport',
    'LI':'Last country to give women the right to vote (1984)',
    'MC':'Smaller than Central Park in New York',
    'SM':'Claims to be the world\'s oldest republic (founded 301 AD)',
    'TO':'One of the first places in the world to see the new day',
    'MN':'Home to the least densely populated country on Earth',
    'GE':'Birthplace of wine \u2014 8000 years of winemaking',
    'AM':'First country to adopt Christianity as state religion (301 AD)',
    'RW':'Known as the "Land of a Thousand Hills"',
    'SI':'Over 60% of the country is covered in forest',
    'EE':'Has the most startups per capita in Europe',
    'IS':'Has no army and no McDonald\'s',
    'ZA':'Has three capital cities',
    'NA':'Home to the world\'s oldest desert (the Namib)',
    'BW':'Home to the Okavango Delta, the largest inland delta',
    'NP':'The only country with a non-rectangular flag',
    'CR':'Abolished its army in 1948',
    'PA':'Only place where you can see the sun rise over the Pacific and set over the Atlantic',
    'FJ':'Made up of 333 islands, only 110 inhabited',
    'JP':'Has more than 6,800 islands',
    'DE':'Has over 1,500 different beers',
    'BR':'Contains 60% of the Amazon rainforest',
    'NZ':'Has more sheep than people',
    'AU':'Home to 21 of the world\'s 25 most venomous snakes'
};

const COUNTRY_DISHES = {
    'ST':'Calulu','TV':'Pulaka','BT':'Ema datshi','MV':'Mas huni',
    'IT':'Pizza','JP':'Ramen','IN':'Butter Chicken','MX':'Tacos',
    'TH':'Pad Thai','VN':'Pho','GR':'Moussaka','ES':'Paella',
    'FR':'Coq au Vin','DE':'Sauerbraten','CN':'Peking Duck',
    'KR':'Kimchi','BR':'Feijoada','CR':'Gallo Pinto','PA':'Sancocho',
    'IS':'Plokkfiskur','NZ':'Pavlova','AU':'Meat Pie','ZA':'Bobotie',
    'GE':'Khachapuri','AM':'Khorovats','NP':'Dal Bhat','KH':'Fish Amok',
    'RW':'Isombe','EE':'Verivorst','LV':'Grey Peas with Bacon',
    'LT':'Cepelinai','SI':'Potica','MN':'Buuz','NA':'Potjiekos',
    'BW':'Seswaa','FJ':'Kokoda','LC':'Green Fig and Saltfish'
};

const FALLBACK_COUNTRIES = [
    {code:'JP',name:'Japan',capital:'Tokyo',population:'125M',languages:['Japanese'],region:'Asia',fun_fact:'Has more than 6,800 islands',dish:'Ramen'},
    {code:'IS',name:'Iceland',capital:'Reykjavik',population:'380K',languages:['Icelandic'],region:'Europe',fun_fact:'Has no army and no McDonald\'s',dish:'Plokkfiskur'},
    {code:'NZ',name:'New Zealand',capital:'Wellington',population:'5M',languages:['English','M\u0101ori'],region:'Oceania',fun_fact:'Has more sheep than people',dish:'Pavlova'},
    {code:'BT',name:'Bhutan',capital:'Thimphu',population:'780K',languages:['Dzongkha'],region:'Asia',fun_fact:'Measures success by Gross National Happiness',dish:'Ema datshi'},
    {code:'CR',name:'Costa Rica',capital:'San Jos\u00e9',population:'5.1M',languages:['Spanish'],region:'Americas',fun_fact:'Abolished its army in 1948',dish:'Gallo Pinto'},
    {code:'BR',name:'Brazil',capital:'Bras\u00edlia',population:'215M',languages:['Portuguese'],region:'Americas',fun_fact:'Contains 60% of the Amazon rainforest',dish:'Feijoada'},
    {code:'EG',name:'Egypt',capital:'Cairo',population:'109M',languages:['Arabic'],region:'Africa',fun_fact:'Home to the only remaining Ancient Wonder of the World',dish:'Koshari'}
];

const FALLBACK_HOROSCOPES = {
    capricorn: 'Your determination pays off today. A challenge becomes an opportunity to shine. Lucky number: 4.',
    aquarius:  'Innovation is your superpower today. Share your unique ideas \u2014 others are more receptive than you think. Lucky number: 11.',
    sagittarius:'Adventure calls, even in small ways. Try something new today. Your optimism is contagious! Lucky number: 7.'
};

// =============================================================================
// STATE
// =============================================================================
let cachedWeather = null;
let cachedForecast = [];
let cachedEvents = [];
let cachedCountry = null;
let cachedAstrology = null;
let currentTravelInfo = null;
let countryDate = null;
let astrologyDate = null;
let lastRefreshStatus = {};

// =============================================================================
// CLOCK
// =============================================================================
function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString('en-GB', {
        hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/Berlin'
    });
    document.getElementById('date').textContent =
        DAY_ABBREV[now.getDay()] + ', ' + MONTH_NAMES[now.getMonth()] + ' ' + now.getDate();

    // Update travel time live
    if (currentTravelInfo && currentTravelInfo.timezone) {
        try {
            const travelTime = now.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',hour12:false,timeZone:currentTravelInfo.timezone});
            const berlinTime = now.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Europe/Berlin'});
            const name = currentTravelInfo.traveler || 'Someone';
            document.getElementById('travel-banner').innerHTML =
                '\u2708\uFE0F <span class="travel-location">' + name + ' in ' + currentTravelInfo.location +
                '</span> <span class="travel-time">' + travelTime +
                '</span> <span class="travel-sun">(Berlin: ' + berlinTime + ')</span>';
        } catch(e) {}
    }
}
setInterval(updateClock, 1000);
updateClock();

// =============================================================================
// WEATHER (Open-Meteo - no API key, CORS-friendly)
// =============================================================================
async function fetchWeather() {
    try {
        const url = 'https://api.open-meteo.com/v1/forecast?' +
            'latitude=' + CONFIG.weatherLat +
            '&longitude=' + CONFIG.weatherLon +
            '&current_weather=true' +
            '&daily=temperature_2m_max,temperature_2m_min,weather_code,sunrise,sunset' +
            '&timezone=Europe/Berlin&forecast_days=7';
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const daily = data.daily || {};

        const sunrise = (daily.sunrise || [''])[0];
        const sunset = (daily.sunset || [''])[0];
        cachedWeather = {
            temp: data.current_weather.temperature,
            condition: data.current_weather.weathercode || 0,
            sunrise: sunrise ? sunrise.slice(11, 16) : '',
            sunset: sunset ? sunset.slice(11, 16) : ''
        };

        cachedForecast = [];
        const times = daily.time || [];
        for (let i = 0; i < times.length; i++) {
            const sr = (daily.sunrise || [])[i] || '';
            const ss = (daily.sunset || [])[i] || '';
            cachedForecast.push({
                date: times[i],
                high: Math.round(daily.temperature_2m_max[i]),
                low: Math.round(daily.temperature_2m_min[i]),
                condition: daily.weather_code[i],
                sunrise: sr ? sr.slice(11, 16) : '',
                sunset: ss ? ss.slice(11, 16) : ''
            });
        }

        renderWeather();
        renderForecast();
        lastRefreshStatus.weather = 'ok';
    } catch (e) {
        console.error('Weather error:', e);
        lastRefreshStatus.weather = 'error';
    }
}

function renderWeather() {
    if (!cachedWeather) return;
    document.getElementById('current-temp').textContent = Math.round(cachedWeather.temp) + '\u00B0';
    document.getElementById('current-icon').textContent = WEATHER_EMOJIS[cachedWeather.condition] || '\u2600\uFE0F';
    const sunEl = document.getElementById('sun-times');
    if (cachedWeather.sunrise && cachedWeather.sunset) {
        sunEl.innerHTML = '<span class="sunrise">\u2600\uFE0F ' + cachedWeather.sunrise +
            '</span><br><span class="sunset">\uD83C\uDF19 ' + cachedWeather.sunset + '</span>';
    }
}

function renderForecast() {
    const grid = document.getElementById('forecast-grid');
    const today = new Date();
    const todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

    grid.innerHTML = cachedForecast.map(f => {
        const parts = f.date.split('-');
        const d = new Date(+parts[0], +parts[1]-1, +parts[2], 12);
        const isToday = f.date === todayStr;
        return '<div class="forecast-day' + (isToday ? ' today-forecast' : '') + '">' +
            '<div class="forecast-day-name">' + (isToday ? 'Today' : DAY_ABBREV[d.getDay()]) + '</div>' +
            '<div class="forecast-day-icon">' + (WEATHER_EMOJIS[f.condition] || '\u2600\uFE0F') + '</div>' +
            '<div class="forecast-day-temps"><span class="forecast-high">' + f.high + '\u00B0</span> <span class="forecast-low">' + f.low + '\u00B0</span></div>' +
            '</div>';
    }).join('');
}

// =============================================================================
// BVG TRANSIT (public REST API, CORS-friendly)
// =============================================================================
async function fetchTransit() {
    try {
        const url = 'https://v6.bvg.transport.rest/stops/' + CONFIG.bvgStopId + '/departures?lines=' + CONFIG.bvgLines + '&duration=30';
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const departures = (data.departures || []).slice(0, 5);
        renderTransit(departures);
        lastRefreshStatus.transit = 'ok';
    } catch (e) {
        console.error('Transit error:', e);
        lastRefreshStatus.transit = 'error';
    }
}

function renderTransit(departures) {
    const bvgList = document.getElementById('bvg-list');
    if (departures.length === 0) {
        bvgList.innerHTML = '<div style="color:rgba(255,255,255,0.3);font-style:italic;padding:10px;">No upcoming departures</div>';
        return;
    }
    bvgList.innerHTML = departures.slice(0, 3).map(d => {
        const when = new Date(d.when);
        const diffMin = Math.round((when - new Date()) / 60000);
        const timeStr = diffMin <= 0 ? 'Now' : diffMin + ' min';
        const timeColor = diffMin <= 3 ? 'color:#FF6B6B;' : 'color:#FFD700;';
        let direction = d.direction;
        if (direction.includes(',')) direction = direction.split(',')[0];
        if (direction.length > 25) direction = direction.substring(0, 22) + '...';
        return '<div class="bvg-item"><span class="bvg-line">' + d.line.name +
            '</span><span class="bvg-destination">' + direction +
            '</span><span class="bvg-time" style="' + timeColor + '">' + timeStr + '</span></div>';
    }).join('');
}

// =============================================================================
// COUNTRY OF THE DAY (restcountries.com - public, CORS-friendly)
// =============================================================================
function getTodayStr() {
    const now = new Date();
    return now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
}

// Deterministic daily country pick based on date
function getDailyCountryCode() {
    const today = getTodayStr();
    let hash = 0;
    for (let i = 0; i < today.length; i++) {
        hash = ((hash << 5) - hash) + today.charCodeAt(i);
        hash |= 0;
    }
    return INTERESTING_COUNTRIES[Math.abs(hash) % INTERESTING_COUNTRIES.length];
}

async function fetchCountry() {
    const today = getTodayStr();
    if (countryDate === today && cachedCountry) {
        renderCountry();
        return;
    }

    try {
        const code = getDailyCountryCode();
        const resp = await fetch('https://restcountries.com/v3.1/alpha/' + code);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const arr = await resp.json();
        const c = arr[0];

        const cca2 = c.cca2 || '';
        let flagEmoji = '';
        if (cca2.length === 2) {
            flagEmoji = String.fromCodePoint(cca2.charCodeAt(0) + 127397) + String.fromCodePoint(cca2.charCodeAt(1) + 127397);
        }

        const languages = Object.values(c.languages || {});
        const capitals = c.capital || [];
        const pop = c.population || 0;
        let popStr = pop > 1000000 ? (pop / 1000000).toFixed(1) + 'M' : pop > 1000 ? (pop / 1000).toFixed(1) + 'K' : String(pop);

        let funFact = COUNTRY_FACTS[cca2] || getFunFact(c);
        let dish = COUNTRY_DISHES[cca2] || 'Traditional stew';

        cachedCountry = {
            code: cca2, name: c.name.common, capital: capitals[0] || 'N/A',
            population: popStr, languages: languages.slice(0, 3),
            flag_emoji: flagEmoji, region: c.region || 'Unknown',
            fun_fact: funFact, dish: dish
        };
        countryDate = today;
        renderCountry();
        lastRefreshStatus.country = 'ok';
    } catch (e) {
        console.error('Country error:', e);
        if (!cachedCountry) {
            cachedCountry = FALLBACK_COUNTRIES[Math.abs(getTodayStr().charCodeAt(4)) % FALLBACK_COUNTRIES.length];
            countryDate = today;
        }
        renderCountry();
        lastRefreshStatus.country = 'error';
    }
}

function getFunFact(countryData) {
    if (countryData.landlocked) {
        const borders = countryData.borders || [];
        return 'A landlocked country with ' + borders.length + ' neighbor' + (borders.length !== 1 ? 's' : '');
    }
    const area = countryData.area || 0;
    const pop = countryData.population || 0;
    if (pop && area > 0) {
        const density = pop / area;
        if (density < 5) return 'One of the least densely populated places on Earth';
        if (density > 1000) return 'One of the most densely populated places on Earth';
    }
    if (area && area < 1000) return 'Tiny nation \u2014 only ' + Math.round(area) + ' km\u00B2 in area';
    return 'A fascinating place to explore!';
}

function renderCountry() {
    if (!cachedCountry) return;
    const c = cachedCountry;
    document.getElementById('country-flag').textContent = c.flag_emoji || '\uD83C\uDFF3\uFE0F';
    document.getElementById('country-name').textContent = c.name;
    document.getElementById('country-details').innerHTML =
        '\uD83C\uDFDB\uFE0F ' + (c.capital || 'N/A') +
        ' &nbsp;|&nbsp; \uD83D\uDC65 ' + (c.population || '--') +
        ' &nbsp;|&nbsp; \uD83D\uDDE3\uFE0F ' + ((c.languages && c.languages[0]) || '--') +
        ' &nbsp;|&nbsp; \uD83D\uDCA1 ' + (c.fun_fact || 'A fascinating place!');
    document.getElementById('country-dish').textContent = '\uD83C\uDF5C Try: ' + (c.dish || 'Traditional stew');
}

// =============================================================================
// ASTROLOGY (horoscope-app-api.vercel.app - public, CORS-friendly)
// =============================================================================
async function fetchAstrology() {
    const today = getTodayStr();
    if (astrologyDate === today && cachedAstrology) {
        renderAstrology();
        return;
    }

    const signs = ['Capricorn', 'Aquarius', 'Sagittarius'];
    const results = {};

    for (const sign of signs) {
        try {
            const url = 'https://horoscope-app-api.vercel.app/api/v1/get-horoscope/daily?sign=' + sign + '&day=TODAY';
            const resp = await fetch(url);
            if (resp.ok) {
                const data = await resp.json();
                if (data.success && data.data && data.data.horoscope_data) {
                    results[sign.toLowerCase()] = data.data.horoscope_data;
                }
            }
        } catch (e) {
            console.error('Horoscope error for ' + sign + ':', e);
        }
    }

    cachedAstrology = {
        capricorn: results.capricorn || FALLBACK_HOROSCOPES.capricorn,
        aquarius: results.aquarius || FALLBACK_HOROSCOPES.aquarius,
        sagittarius: results.sagittarius || FALLBACK_HOROSCOPES.sagittarius
    };
    astrologyDate = today;
    renderAstrology();
    lastRefreshStatus.astrology = 'ok';
}

function renderAstrology() {
    if (!cachedAstrology) return;
    // Daddy & Wren share Capricorn, Ellis = Aquarius, Papa = Sagittarius
    document.getElementById('astro-capricorn').textContent = cachedAstrology.capricorn;
    document.getElementById('astro-capricorn-2').textContent = cachedAstrology.capricorn;
    document.getElementById('astro-aquarius').textContent = cachedAstrology.aquarius;
    document.getElementById('astro-sagittarius').textContent = cachedAstrology.sagittarius;
}

// =============================================================================
// CALENDAR (Google Apps Script proxy)
// =============================================================================
async function fetchCalendar() {
    if (!CONFIG.calendarProxyUrl) {
        renderCalendar([]);
        return;
    }

    try {
        const resp = await fetch(CONFIG.calendarProxyUrl);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const events = await resp.json();

        // Detect travel from all-day events
        currentTravelInfo = null;
        const todayStr = getTodayStr();
        const travelBanner = document.getElementById('travel-banner');

        for (const evt of events) {
            if (evt.is_all_day) {
                const travel = detectTravel(evt.title, evt.location || '');
                if (travel && evt.date === todayStr) {
                    currentTravelInfo = travel;
                    travelBanner.classList.add('active');
                    break;
                }
            }
        }
        if (!currentTravelInfo) {
            travelBanner.classList.remove('active');
        }

        cachedEvents = events;
        renderCalendar(events);
        lastRefreshStatus.calendar = 'ok';
    } catch (e) {
        console.error('Calendar error:', e);
        renderCalendar(cachedEvents);
        lastRefreshStatus.calendar = 'error';
    }
}

function detectTravel(title, location) {
    const text = (title + ' ' + location).toLowerCase();
    for (const [loc, tz] of Object.entries(CONFIG.locationTimezones)) {
        if (text.includes(loc)) {
            let traveler = null;
            if (text.includes('papa') || text.includes('joshua')) traveler = 'Papa';
            else if (text.includes('daddy') || text.includes('scott')) traveler = 'Daddy';
            return { traveler: traveler, location: loc.charAt(0).toUpperCase() + loc.slice(1), timezone: tz };
        }
    }
    return null;
}

function generate7Days() {
    const days = [];
    const today = new Date();
    today.setHours(12, 0, 0, 0);
    for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() + i);
        days.push(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'));
    }
    return days;
}

function formatDayName(dateStr) {
    const parts = dateStr.split('-');
    const d = new Date(+parts[0], +parts[1]-1, +parts[2], 12);
    const today = new Date(); today.setHours(0,0,0,0);
    const check = new Date(d); check.setHours(0,0,0,0);
    return check.getTime() === today.getTime() ? 'TODAY' : DAY_ABBREV[d.getDay()];
}

function formatDateShort(dateStr) {
    const parts = dateStr.split('-');
    const d = new Date(+parts[0], +parts[1]-1, +parts[2], 12);
    return MONTH_NAMES[d.getMonth()] + ' ' + d.getDate();
}

function renderCalendar(events) {
    const allDays = generate7Days();
    const forecastMap = {};
    cachedForecast.forEach(f => forecastMap[f.date] = f);

    const eventsByDate = {};
    events.forEach(e => {
        if (!eventsByDate[e.date]) eventsByDate[e.date] = [];
        const existing = eventsByDate[e.date].find(ex => ex.title === e.title);
        if (existing) {
            if (!existing.calendars.includes(e.calendar)) existing.calendars.push(e.calendar);
        } else {
            eventsByDate[e.date].push({title: e.title, time: e.time, calendars: [e.calendar]});
        }
    });

    const html = allDays.map(date => {
        const isToday = date === allDays[0];
        const dayName = formatDayName(date);
        const dayEvents = eventsByDate[date] || [];
        const forecast = forecastMap[date];

        let eventsHtml = dayEvents.map(e => {
            const emojis = e.calendars.map(c => CONFIG.personEmojis[c] || '\u2753').join('');
            const timeStr = e.time || '';
            const isNoSchool = /no school|schulfrei|ferien/i.test(e.title);
            const titleClass = isNoSchool ? 'event-title event-no-school' : 'event-title';
            const displayTitle = isNoSchool ? '\uD83C\uDF89 ' + e.title : e.title;
            return '<div class="event-item"><span class="event-emojis">' + emojis + '</span>' +
                (timeStr ? '<span class="event-time">' + timeStr + '</span>' : '') +
                '<span class="' + titleClass + '">' + displayTitle + '</span></div>';
        }).join('');

        if (!eventsHtml) eventsHtml = '<span class="no-events">\u2014</span>';

        let weatherHtml = '';
        if (forecast) {
            weatherHtml = '<div class="day-weather"><span class="weather-icon-txt">' +
                (WEATHER_EMOJIS[forecast.condition] || '\u2600\uFE0F') +
                '</span> <span class="weather-temps"><span style="color:#FFD700;">' +
                forecast.high + '\u00B0</span> <span style="color:#6B9BFF;">' +
                forecast.low + '\u00B0</span></span></div>';
        }

        return '<div class="day-row ' + (isToday ? 'today' : '') + '">' +
            '<div class="day-info"><div class="day-name ' + (isToday ? 'today-label' : '') + '">' +
            dayName + '</div><div class="day-date">' + formatDateShort(date) + '</div>' +
            weatherHtml + '</div><div class="day-events">' + eventsHtml + '</div></div>';
    }).join('');

    document.getElementById('calendar-grid').innerHTML = html;
}

// =============================================================================
// REFRESH SCHEDULE
// =============================================================================
async function initialLoad() {
    // Fire all fetches in parallel on first load
    await Promise.allSettled([
        fetchWeather(),
        fetchTransit(),
        fetchCountry(),
        fetchAstrology(),
        fetchCalendar()
    ]);
    renderCalendar(cachedEvents);
    updateStatusBar();
}

function updateStatusBar() {
    const el = document.querySelector('.status-bar');
    if (!el) return;
    const now = new Date();
    el.textContent = 'Last refresh: ' + now.toLocaleTimeString('en-GB', {timeZone:'Europe/Berlin'});
}

// Weather: every 10 min
setInterval(() => { fetchWeather(); }, 10 * 60 * 1000);

// Transit: every 60s
setInterval(() => { fetchTransit(); }, 60 * 1000);

// Country: once daily (check every hour)
setInterval(() => { fetchCountry(); }, 60 * 60 * 1000);

// Astrology: once daily (check every hour)
setInterval(() => { fetchAstrology(); }, 60 * 60 * 1000);

// Calendar: every 5 min
setInterval(() => { fetchCalendar(); }, 5 * 60 * 1000);

// Status bar: every minute
setInterval(updateStatusBar, 60 * 1000);

// Page reload every 6 hours to prevent memory leaks
setTimeout(() => location.reload(), 6 * 60 * 60 * 1000);

// Start
initialLoad();
</script>
</body>
</html>
