---
phase: 05-realtime-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase.ts
  - src/types/database.ts
  - supabase/schema.sql
  - .env.example
autonomous: false
requirements:
  - INFRA-RT-01
  - INFRA-RT-02

must_haves:
  truths:
    - "Supabase project exists with database tables for groceries, timers, chores, chore_completions"
    - "Supabase client singleton initializes without crashing, even when env vars are missing"
    - "TypeScript types exist for all four database tables"
    - "SQL schema file exists that user can copy-paste into Supabase SQL editor"
  artifacts:
    - path: "src/lib/supabase.ts"
      provides: "Supabase client singleton with realtime config"
      contains: "createClient"
    - path: "src/types/database.ts"
      provides: "TypeScript types for all database tables"
      contains: "Grocery"
    - path: "supabase/schema.sql"
      provides: "Complete SQL schema for Supabase setup"
      contains: "create table"
    - path: ".env.example"
      provides: "Template for required environment variables"
      contains: "VITE_SUPABASE"
  key_links:
    - from: "src/lib/supabase.ts"
      to: "src/types/database.ts"
      via: "Database type generic parameter"
      pattern: "createClient<Database>"
---

<objective>
Install Supabase JS client, create database types, SQL schema file, and Supabase client singleton. Includes human checkpoint for Supabase project creation.

Purpose: Establishes the foundation layer that all realtime hooks (Plan 05-02) and future interactive features (Phases 6-9) depend on.
Output: Supabase client ready to use, SQL schema ready for user to execute, typed database interface.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-realtime-infrastructure/05-RESEARCH.md
@src/components/layout/StatusBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase, create types, SQL schema, and client singleton</name>
  <files>
    src/lib/supabase.ts
    src/types/database.ts
    supabase/schema.sql
    .env.example
  </files>
  <action>
1. Install Supabase JS client:
   ```bash
   npm install @supabase/supabase-js
   ```

2. Create `src/types/database.ts` with hand-written types for all four tables (per research recommendation — schema is simple enough, no CLI generation needed):
   ```typescript
   export interface Grocery {
     id: string;
     name: string;
     checked: boolean;
     added_by: string | null;
     created_at: string;
     updated_at: string;
   }

   export interface Timer {
     id: string;
     label: string;
     duration_seconds: number;
     started_at: string;
     cancelled: boolean;
     created_by: string | null;
     created_at: string;
   }

   export interface Chore {
     id: string;
     title: string;
     assigned_to: string | null;
     schedule: 'daily' | 'weekly' | 'once';
     is_active: boolean;
     created_at: string;
   }

   export interface ChoreCompletion {
     id: string;
     chore_id: string;
     completed_by: string;
     completed_at: string;
   }

   export interface Database {
     public: {
       Tables: {
         groceries: { Row: Grocery; Insert: Omit<Grocery, 'id' | 'created_at' | 'updated_at'>; Update: Partial<Omit<Grocery, 'id'>> };
         timers: { Row: Timer; Insert: Omit<Timer, 'id' | 'created_at'>; Update: Partial<Omit<Timer, 'id'>> };
         chores: { Row: Chore; Insert: Omit<Chore, 'id' | 'created_at'>; Update: Partial<Omit<Chore, 'id'>> };
         chore_completions: { Row: ChoreCompletion; Insert: Omit<ChoreCompletion, 'id' | 'completed_at'>; Update: Partial<Omit<ChoreCompletion, 'id'>> };
       };
     };
   }
   ```

3. Create `supabase/schema.sql` containing the complete SQL from the research doc:
   - Four tables: groceries, timers, chores, chore_completions
   - UUID primary keys with gen_random_uuid()
   - Timestamps with timestamptz
   - Foreign key from chore_completions to chores with cascade delete
   - Enable RLS on all tables
   - Permissive "Allow all" policies for anon key access (no auth per PROJECT.md)
   - Add all tables to supabase_realtime publication
   - Include clear comments explaining each section

4. Create `src/lib/supabase.ts`:
   - Read VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY from import.meta.env
   - Export `supabaseEnabled` boolean (true only when BOTH env vars are present and non-empty)
   - If not enabled, export `supabase` as `null` (NOT a crashed client)
   - If enabled, create singleton with `createClient<Database>()` and realtime config:
     - `worker: true` for Web Worker heartbeats (mobile Safari background tab resilience)
     - `heartbeatCallback` that reconnects on 'disconnected' status
   - Export type `SupabaseClient` for consumers that need to type-check

5. Update `.env.example` (create if not exists, or append) with:
   ```
   # Supabase (Phase 5+) — get from https://supabase.com/dashboard
   VITE_SUPABASE_URL=
   VITE_SUPABASE_ANON_KEY=
   ```

IMPORTANT: The supabase client module MUST gracefully handle missing env vars. When supabase is null, all hooks in Plan 05-02 will skip subscriptions. This ensures the dashboard continues working without Supabase configured.
  </action>
  <verify>
    - `npm run build` succeeds with no TypeScript errors
    - `supabase/schema.sql` exists and contains CREATE TABLE statements for all 4 tables
    - `src/lib/supabase.ts` exports `supabase` and `supabaseEnabled`
    - `src/types/database.ts` exports Database, Grocery, Timer, Chore, ChoreCompletion types
  </verify>
  <done>Supabase client singleton created with graceful null fallback when env vars missing. Database types defined for all 4 tables. SQL schema file ready for user to execute. Build passes.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User creates Supabase project and executes schema SQL</name>
  <action>
User must create a Supabase project and configure the database. Claude cannot do this — it requires account creation and a web dashboard.
  </action>
  <instructions>
**Steps to complete:**

1. **Create Supabase account** (if you don't have one): Visit https://supabase.com and sign up (free tier is sufficient)

2. **Create a new project:**
   - Click "New Project"
   - Name: `family-dashboard` (or whatever you prefer)
   - Database password: generate a strong one (you won't need it for the app, just save it)
   - Region: `eu-central-1` (Frankfurt — closest to Berlin)
   - Wait for project to finish provisioning (~2 minutes)

3. **Run the schema SQL:**
   - Go to SQL Editor (left sidebar)
   - Click "New query"
   - Copy-paste the entire contents of `supabase/schema.sql`
   - Click "Run" — should show "Success. No rows returned" for each statement

4. **Get your project credentials:**
   - Go to Settings > API (left sidebar)
   - Copy "Project URL" (looks like `https://xxxxx.supabase.co`)
   - Copy "anon public" key under "Project API keys"

5. **Create `.env.local` in the project root:**
   ```
   VITE_SUPABASE_URL=https://your-project.supabase.co
   VITE_SUPABASE_ANON_KEY=your-anon-key-here
   ```

6. **Verify the tables exist:**
   - In Supabase dashboard, go to Table Editor (left sidebar)
   - You should see: groceries, timers, chores, chore_completions
   - Each table should have columns matching the schema

Type "done" when complete, or describe any issues.
  </instructions>
  <resume-signal>Type "done" when Supabase project is created and .env.local is configured</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes with no errors
- `supabase/schema.sql` contains valid SQL for 4 tables + RLS + realtime publication
- Supabase client gracefully returns null when env vars are missing
- After user completes Task 2: `.env.local` exists with VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY
</verification>

<success_criteria>
- Supabase JS installed and importable
- Database types cover all 4 tables with Row/Insert/Update variants
- SQL schema file is self-contained and executable in Supabase SQL Editor
- Client singleton handles missing env vars without crashing
- User has Supabase project with tables created and credentials in .env.local
</success_criteria>

<output>
After completion, create `.planning/phases/05-realtime-infrastructure/05-01-SUMMARY.md`
</output>
