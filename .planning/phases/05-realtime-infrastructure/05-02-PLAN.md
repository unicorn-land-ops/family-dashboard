---
phase: 05-realtime-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - src/hooks/useSupabaseRealtime.ts
  - src/hooks/useConnectionStatus.ts
  - src/hooks/useOfflineQueue.ts
  - src/components/layout/ConnectionStatus.tsx
  - src/components/layout/StatusBar.tsx
autonomous: true
requirements:
  - INFRA-RT-03
  - INFRA-RT-04
  - INFRA-RT-05
  - INFRA-RT-06
  - INFRA-RT-07

must_haves:
  truths:
    - "Real-time updates from Supabase tables arrive via WebSocket within 1 second"
    - "Connection status indicator shows connected/reconnecting/offline in the status bar"
    - "When offline, mutations queue in localStorage and replay on reconnect"
    - "WebSocket subscriptions clean up on component unmount (no memory leaks)"
    - "Background tab on mobile Safari reconnects when tab becomes visible"
    - "When Supabase is not configured, all hooks gracefully no-op"
  artifacts:
    - path: "src/hooks/useSupabaseRealtime.ts"
      provides: "Generic realtime subscription hook for any table"
      exports: ["useSupabaseRealtime"]
    - path: "src/hooks/useConnectionStatus.ts"
      provides: "WebSocket connection state tracking"
      exports: ["useConnectionStatus"]
    - path: "src/hooks/useOfflineQueue.ts"
      provides: "localStorage-backed mutation queue with flush on reconnect"
      exports: ["useOfflineQueue", "enqueue"]
    - path: "src/components/layout/ConnectionStatus.tsx"
      provides: "Visual dot + label for connection state"
      exports: ["ConnectionStatus"]
    - path: "src/components/layout/StatusBar.tsx"
      provides: "Updated footer with ConnectionStatus integrated"
      contains: "ConnectionStatus"
  key_links:
    - from: "src/hooks/useSupabaseRealtime.ts"
      to: "src/lib/supabase.ts"
      via: "imports supabase client singleton"
      pattern: "import.*supabase.*from.*lib/supabase"
    - from: "src/hooks/useConnectionStatus.ts"
      to: "src/lib/supabase.ts"
      via: "subscribes to connection monitor channel"
      pattern: "supabase.*channel.*connection"
    - from: "src/hooks/useOfflineQueue.ts"
      to: "src/lib/supabase.ts"
      via: "uses supabase client for flush operations"
      pattern: "supabase.*from.*insert|update|delete"
    - from: "src/components/layout/StatusBar.tsx"
      to: "src/components/layout/ConnectionStatus.tsx"
      via: "renders ConnectionStatus component"
      pattern: "<ConnectionStatus"
---

<objective>
Build the realtime subscription hook, connection status tracking, offline mutation queue, and connection status UI component. Wire the connection indicator into the existing StatusBar.

Purpose: Provides the reusable hooks that Phases 6-9 will use for live data sync, and gives the user immediate visual feedback about connection state.
Output: Three hooks (useSupabaseRealtime, useConnectionStatus, useOfflineQueue) and ConnectionStatus component in StatusBar.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-realtime-infrastructure/05-RESEARCH.md
@.planning/phases/05-realtime-infrastructure/05-01-SUMMARY.md
@src/components/layout/StatusBar.tsx
@src/lib/supabase.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create realtime subscription hook, connection status hook, and offline queue</name>
  <files>
    src/hooks/useSupabaseRealtime.ts
    src/hooks/useConnectionStatus.ts
    src/hooks/useOfflineQueue.ts
  </files>
  <action>
1. Create `src/hooks/useSupabaseRealtime.ts`:
   - Generic hook that subscribes to `postgres_changes` on a specified table
   - Parameters: `{ table, event ('*' | 'INSERT' | 'UPDATE' | 'DELETE'), schema ('public'), filter (optional), onPayload callback }`
   - Uses `supabase.channel('{table}-changes')` with `.on('postgres_changes', ...)` then `.subscribe()`
   - Cleanup: `supabase.removeChannel(channel)` in useEffect return (NOT just unsubscribe — per research pitfall)
   - Use `useRef` for channelRef to ensure proper cleanup
   - Wrap `onPayload` in `useRef` to avoid re-subscribing when callback identity changes (stable reference pattern)
   - If `supabaseEnabled` is false (from `src/lib/supabase.ts`), early-return with no subscription
   - Log subscription status changes to console for debugging

2. Create `src/hooks/useConnectionStatus.ts`:
   - Returns `ConnectionState` type: `'connected' | 'reconnecting' | 'offline' | 'disabled'`
   - If `supabaseEnabled` is false, return `'disabled'` immediately (no subscriptions)
   - Create a dedicated `connection-monitor` channel and subscribe
   - Map channel statuses: SUBSCRIBED -> 'connected', CHANNEL_ERROR/TIMED_OUT -> 'offline', CLOSED -> 'reconnecting'
   - Listen to `document.visibilitychange` event for mobile Safari background tab recovery:
     - When `document.visibilityState === 'visible'`, set status to 'reconnecting' and call `supabase.realtime.connect()`
   - Cleanup: remove channel AND remove visibilitychange listener
   - Initial state should be 'reconnecting' (optimistic — assumes connection is being established)

3. Create `src/hooks/useOfflineQueue.ts`:
   - Export `QueuedMutation` interface: `{ id: string, table: string, operation: 'insert' | 'update' | 'delete', data: Record<string, unknown>, timestamp: number }`
   - Storage key: `'family_dashboard_offline_queue'`
   - Export `getQueue(): QueuedMutation[]` — parse from localStorage
   - Export `enqueue(mutation: Omit<QueuedMutation, 'id' | 'timestamp'>): void` — append to queue with crypto.randomUUID() id and Date.now() timestamp
   - Export `flushQueue(): Promise<{ flushed: number, failed: number }>` — iterate queue, execute each against supabase client (insert/update/delete), keep failed items in queue, return counts
   - Export `useOfflineQueue()` hook that:
     - Takes `connectionStatus: ConnectionState` parameter
     - When status transitions TO 'connected', call `flushQueue()` and log results
     - Use `useRef` to track previous status to detect transitions (not just current state)
     - Returns `{ queueLength: number }` for potential UI display
   - If `supabaseEnabled` is false, `enqueue` still works (queues locally), `flushQueue` is a no-op returning `{ flushed: 0, failed: 0 }`

IMPORTANT: All three hooks must gracefully no-op when Supabase is not configured. Check `supabaseEnabled` before any Supabase client interaction. The `supabase` import may be null.
  </action>
  <verify>
    - `npm run build` passes with no TypeScript errors
    - All three hook files export their named exports
    - No direct `supabase.` calls without checking `supabaseEnabled` first
  </verify>
  <done>Three hooks created: useSupabaseRealtime (generic table subscription), useConnectionStatus (connection state tracking with mobile Safari handling), useOfflineQueue (localStorage mutation queue with auto-flush on reconnect). All gracefully handle missing Supabase configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Create ConnectionStatus component and wire into StatusBar</name>
  <files>
    src/components/layout/ConnectionStatus.tsx
    src/components/layout/StatusBar.tsx
  </files>
  <action>
1. Create `src/components/layout/ConnectionStatus.tsx`:
   - Import and use `useConnectionStatus` hook
   - Import and use `useOfflineQueue` hook, passing the connection status
   - Display a small dot indicator with label:
     - connected: green dot, "Connected" label (only show briefly, then fade to just dot)
     - reconnecting: yellow dot with CSS pulse animation, "Reconnecting..." label
     - offline: red dot, "Offline" label, show queue count if > 0 (e.g., "Offline (2 pending)")
     - disabled: no indicator rendered (return null) — when Supabase is not configured
   - Style: `flex items-center gap-1.5 text-xs` matching StatusBar's text-secondary opacity
   - The dot: `w-1.5 h-1.5 rounded-full` with appropriate bg color from Tailwind
   - Add CSS pulse animation for reconnecting state using Tailwind's `animate-pulse`
   - When connected, auto-hide the label after 3 seconds (show just the green dot) to avoid visual noise on the always-on kiosk display. Use useState + useEffect with setTimeout.

2. Update `src/components/layout/StatusBar.tsx`:
   - Import ConnectionStatus component
   - Add `<ConnectionStatus />` between the "Last refresh" span and the "Family Dashboard" span
   - Keep existing layout: justify-between with the three elements
   - Adjust to use `justify-between` with three children (refresh left, connection center, brand right)
   - Preserve all existing styles and behavior

Do NOT add CSS to index.css — use only Tailwind utility classes. The `animate-pulse` class is built into Tailwind.
  </action>
  <verify>
    - `npm run build` passes with no TypeScript errors
    - StatusBar.tsx imports and renders ConnectionStatus
    - ConnectionStatus returns null when supabase is disabled (no visual change to existing dashboard)
    - `npm run dev` shows dashboard without errors (connection indicator should show "disabled" state = invisible when no env vars)
  </verify>
  <done>ConnectionStatus component shows connection state with colored dot + label. StatusBar updated to include connection indicator between refresh timestamp and brand name. When Supabase is not configured, indicator is invisible — zero visual change to existing dashboard.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- All hook files exist and export their public API
- ConnectionStatus component renders in StatusBar
- Without Supabase env vars: dashboard loads identically to before (no connection indicator visible)
- With Supabase env vars: green/yellow/red dot appears in status bar based on connection state
- useSupabaseRealtime cleanup uses supabase.removeChannel() (not just unsubscribe)
- useConnectionStatus listens to visibilitychange for mobile Safari recovery
- useOfflineQueue persists to localStorage and flushes on reconnect transition
</verification>

<success_criteria>
- Three reusable hooks ready for Phases 6-9 to import
- Connection status visible in StatusBar when Supabase is configured
- Offline queue persists mutations and replays on reconnect
- All WebSocket subscriptions clean up properly on unmount
- Mobile Safari background tab scenario handled via visibilitychange + reconnect
- Dashboard works identically when Supabase env vars are absent
</success_criteria>

<output>
After completion, create `.planning/phases/05-realtime-infrastructure/05-02-SUMMARY.md`
</output>
