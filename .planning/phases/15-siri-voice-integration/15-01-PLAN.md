---
phase: 15-siri-voice-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/siri-shortcuts/grocery-shortcut.md
  - docs/siri-shortcuts/timer-shortcut.md
  - docs/siri-shortcuts/README.md
autonomous: false
requirements: [SIRI-01, SIRI-02]

must_haves:
  truths:
    - "User can say 'Hey Siri, grocery' and add items that appear on the wall display grocery list"
    - "User can say 'Hey Siri, timer' and start a timer that appears on the wall display"
    - "Multiple grocery items in one command are parsed and added individually"
    - "Duplicate grocery items (case-insensitive) are silently skipped"
    - "Timer with missing duration prompts the user for duration"
    - "Siri speaks confirmation after successful grocery add or timer creation"
    - "Network failure retries once, then shows 'Couldn't reach the dashboard' error"
  artifacts:
    - path: "docs/siri-shortcuts/grocery-shortcut.md"
      provides: "Step-by-step Apple Shortcut creation guide for grocery voice commands"
    - path: "docs/siri-shortcuts/timer-shortcut.md"
      provides: "Step-by-step Apple Shortcut creation guide for timer voice commands"
    - path: "docs/siri-shortcuts/README.md"
      provides: "Overview, Supabase config, and iCloud sharing instructions"
  key_links:
    - from: "Apple Shortcuts (Grocery)"
      to: "Supabase PostgREST /rest/v1/groceries"
      via: "HTTP POST with anon key"
      pattern: "Get Contents of URL.*groceries"
    - from: "Apple Shortcuts (Timer)"
      to: "Supabase PostgREST /rest/v1/timers"
      via: "HTTP POST with anon key"
      pattern: "Get Contents of URL.*timers"
    - from: "Supabase PostgREST INSERT"
      to: "Dashboard realtime subscriptions"
      via: "Supabase realtime publication (already configured)"
      pattern: "supabase_realtime add table"
---

<objective>
Create two Apple Shortcuts (Grocery and Timer) that write directly to Supabase PostgREST, enabling hands-free voice control via Siri. Verify the REST endpoints work, then provide step-by-step Shortcut creation guides for the user.

Purpose: Family can manage groceries and timers hands-free via Siri on their iPhones, with items propagating to the wall display in real-time.
Output: PostgREST endpoint verification, three documentation files with Shortcut creation instructions.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-siri-voice-integration/15-RESEARCH.md
@.planning/phases/11-horoscope-fix-rls-prep/11-01-SUMMARY.md
@supabase/schema.sql
@supabase/rls-policies.sql
@src/lib/supabase.ts
@src/lib/api/groceries.ts
@src/lib/api/timers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify PostgREST endpoints and create Shortcut documentation</name>
  <files>
    docs/siri-shortcuts/README.md
    docs/siri-shortcuts/grocery-shortcut.md
    docs/siri-shortcuts/timer-shortcut.md
  </files>
  <action>
First, read the Supabase project URL and anon key from the existing `.env` file (look for VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY). These values are needed for the curl verification and the Shortcut configuration.

Verify PostgREST endpoints work with curl using the anon key:

1. **Grocery INSERT test:**
   ```
   curl -X POST "$SUPABASE_URL/rest/v1/groceries" \
     -H "apikey: $ANON_KEY" \
     -H "Authorization: Bearer $ANON_KEY" \
     -H "Content-Type: application/json" \
     -d '{"name": "siri-test-item", "checked": false, "added_by": "siri"}'
   ```
   Verify: returns 201. Then clean up: DELETE where name = 'siri-test-item'.

2. **Grocery duplicate check (case-insensitive):**
   ```
   GET $SUPABASE_URL/rest/v1/groceries?name=ilike.siri-test-item&checked=eq.false&select=id
   ```
   Verify: returns empty array after cleanup.

3. **Timer INSERT test:**
   ```
   curl -X POST "$SUPABASE_URL/rest/v1/timers" \
     -H "apikey: $ANON_KEY" \
     -H "Authorization: Bearer $ANON_KEY" \
     -H "Content-Type: application/json" \
     -d '{"label": "siri-test-timer", "duration_seconds": 5, "started_at": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"}'
   ```
   Verify: returns 201. Then clean up: DELETE where label = 'siri-test-timer'.

After verification, create three documentation files:

**docs/siri-shortcuts/README.md** — Overview document:
- What these Shortcuts do (grocery voice add + timer voice start)
- Prerequisites: Supabase project URL and anon key (tell user where to find these in the Supabase Dashboard under Settings > API)
- How to share Shortcuts with family via iCloud link
- Link to the two detailed guides

**docs/siri-shortcuts/grocery-shortcut.md** — Step-by-step guide to create the Grocery Shortcut in the Apple Shortcuts app. Include:
- Shortcut name: "Grocery"
- Trigger: "Hey Siri, grocery" -> Siri asks "What would you like to add?"
- Complete action-by-action instructions (numbered steps with exact action names, parameter values, variable names)
- Flow: Ask for Input -> Replace " and " with "," -> Split by "," -> Repeat with Each -> Trim -> GET duplicate check (ilike, case-insensitive) -> Count -> If count=0 -> POST insert {name, checked: false, added_by: "siri"} -> Add to Variable addedItems -> End loop -> Show Result "Added [items]" or "Already on the list"
- Error handling: Wrap the GET+POST in a retry loop (Repeat count 2) — on first network failure retry silently, on second failure Show Result "Couldn't reach the dashboard"
- Include placeholder markers [YOUR_SUPABASE_URL] and [YOUR_ANON_KEY] for user to fill in
- Multi-item parsing: commas and "and" as delimiters (NOT spaces, to preserve "orange juice" as one item)
- Quantities stored as part of name ("2 milk" stays as "2 milk")
- Duplicate check is case-insensitive via ilike filter
- URL encoding note: Use "URL Encode" text action on item name before constructing the GET URL for the duplicate check

**docs/siri-shortcuts/timer-shortcut.md** — Step-by-step guide to create the Timer Shortcut. Include:
- Shortcut name: "Timer"
- Trigger: "Hey Siri, timer" -> Siri asks "What timer would you like to set?"
- Complete action-by-action instructions
- Flow: Ask for Input -> Match Text regex `(\d+)\s*(seconds?|minutes?|hours?)` -> If match: extract groups for number+unit, derive timer name (everything before the duration) -> If no match: set timerName = full input, Ask for Input "How long should the timer be?", Match Text again -> Calculate duration_seconds (hours*3600, minutes*60, seconds*1) -> Format Current Date as ISO 8601 -> POST insert {label, duration_seconds, started_at} -> Show Result "[Name] timer set for [duration]"
- Error handling: Same retry pattern as grocery shortcut
- No max duration limit, duplicate timer names allowed
- Include [YOUR_SUPABASE_URL] and [YOUR_ANON_KEY] placeholders
- ISO date format string: "yyyy-MM-dd'T'HH:mm:ss.SSSZZZZZ" for proper timezone handling

IMPORTANT: These are NOT markdown README docs — they are precise, step-by-step Apple Shortcuts construction guides. Each action should be numbered and specify the exact Shortcuts action name, its parameters, and how to wire inputs/outputs. A user should be able to follow the guide screen-by-screen in the Shortcuts app.
  </action>
  <verify>
1. curl POST to /rest/v1/groceries returns 201 (or 200) with anon key
2. curl GET to /rest/v1/groceries?name=ilike.X&checked=eq.false returns array
3. curl POST to /rest/v1/timers returns 201 (or 200) with anon key
4. docs/siri-shortcuts/README.md exists and has prerequisites section
5. docs/siri-shortcuts/grocery-shortcut.md exists with numbered action steps
6. docs/siri-shortcuts/timer-shortcut.md exists with numbered action steps
  </verify>
  <done>
PostgREST endpoints verified working with anon key for both groceries and timers tables. Three Shortcut documentation files created with complete step-by-step action sequences, error handling, and configuration placeholders.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User creates Apple Shortcuts and tests voice commands</name>
  <action>
The user must create the two Apple Shortcuts on their iPhone following the guides, then test them.
  </action>
  <how-to-verify>
**Setup (one-time):**
1. Open the Apple Shortcuts app on your iPhone
2. Get your Supabase project URL and anon key from Supabase Dashboard > Settings > API
3. Follow `docs/siri-shortcuts/grocery-shortcut.md` to create the "Grocery" shortcut
4. Follow `docs/siri-shortcuts/timer-shortcut.md` to create the "Timer" shortcut

**Test Grocery Shortcut:**
1. Say "Hey Siri, grocery"
2. When prompted, say "milk, eggs, and bread"
3. Verify: Siri says "Added milk, eggs, bread"
4. Verify: milk, eggs, and bread appear on the wall display grocery list
5. Say "Hey Siri, grocery" again and say "milk"
6. Verify: Siri says "Already on the list" (duplicate skip)

**Test Timer Shortcut:**
1. Say "Hey Siri, timer"
2. When prompted, say "pasta 10 minutes"
3. Verify: Siri says "pasta timer set for 10 minutes"
4. Verify: A 10-minute pasta timer appears on the wall display
5. Say "Hey Siri, timer" again and say "tea"
6. Verify: Siri asks "How long should the timer be?"
7. Say "5 minutes"
8. Verify: Siri says "tea timer set for 5 minutes"

**Test Error Handling:**
1. Temporarily use an invalid Supabase URL in one Shortcut
2. Trigger the Shortcut
3. Verify: After brief delay, Siri says "Couldn't reach the dashboard"

**Share with Family:**
1. Long-press each Shortcut > Share > Copy iCloud Link
2. Send the links to family members
3. Family members tap the link to install
  </how-to-verify>
  <resume-signal>Type "approved" if both Shortcuts work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. PostgREST grocery INSERT via anon key works (curl returns 201)
2. PostgREST timer INSERT via anon key works (curl returns 201)
3. Case-insensitive duplicate grocery check via ilike filter works
4. Grocery Shortcut adds items that appear on wall display via realtime
5. Timer Shortcut starts timers that appear on wall display via realtime
6. Multi-item grocery input is parsed correctly (commas and "and" as delimiters)
7. Duplicate grocery items are silently skipped
8. Missing timer duration triggers a follow-up voice prompt
9. Network failure shows "Couldn't reach the dashboard" after one retry
10. Shortcuts can be shared via iCloud link
</verification>

<success_criteria>
- User says "Hey Siri, grocery" -> dictates items -> items appear on wall display grocery list
- User says "Hey Siri, timer" -> dictates name and duration -> timer starts on wall display
- Both Shortcuts use Supabase anon key (not service_role)
- Items added via Siri propagate to all connected devices via existing realtime subscriptions
- Shortcut documentation enables family members to install via iCloud link
</success_criteria>

<output>
After completion, create `.planning/phases/15-siri-voice-integration/15-01-SUMMARY.md`
</output>
