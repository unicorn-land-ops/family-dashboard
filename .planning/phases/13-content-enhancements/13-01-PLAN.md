---
phase: 13-content-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/api/bvgTransit.ts
  - src/components/sidebar/TransitPanel.tsx
  - src/lib/api/countryOfDay.ts
  - src/hooks/useCountryOfDay.ts
  - src/components/sidebar/CountryPanel.tsx
autonomous: true
requirements: [TRNS-01, CTRY-01]
user_setup:
  - service: unsplash
    why: "Country landscape photos via Unsplash search API"
    env_vars:
      - name: VITE_UNSPLASH_ACCESS_KEY
        source: "Register at unsplash.com/developers -> New Application -> Access Key"
    dashboard_config: []

must_haves:
  truths:
    - "BVG departures panel shows exactly 3 upcoming departures"
    - "Country of the Day displays a landscape photo from that country"
    - "Unsplash attribution (photographer name + Unsplash link with UTM params) is visible below the photo"
    - "Country panel works without photo when Unsplash fails or returns no results"
  artifacts:
    - path: "src/lib/api/bvgTransit.ts"
      provides: "BVG departure fetch limited to 3 results"
      contains: "results=3"
    - path: "src/lib/api/countryOfDay.ts"
      provides: "Unsplash photo fetching with download trigger"
      exports: ["fetchCountryImage"]
    - path: "src/hooks/useCountryOfDay.ts"
      provides: "React Query hook for country image"
      exports: ["useCountryImage"]
    - path: "src/components/sidebar/CountryPanel.tsx"
      provides: "Country panel with landscape photo and attribution"
      contains: "UnsplashAttribution"
    - path: "src/components/sidebar/TransitPanel.tsx"
      provides: "Transit skeleton with 3 placeholders"
      contains: "length: 3"
  key_links:
    - from: "src/components/sidebar/CountryPanel.tsx"
      to: "src/hooks/useCountryOfDay.ts"
      via: "useCountryImage hook call"
      pattern: "useCountryImage"
    - from: "src/hooks/useCountryOfDay.ts"
      to: "src/lib/api/countryOfDay.ts"
      via: "fetchCountryImage query function"
      pattern: "fetchCountryImage"
    - from: "src/lib/api/countryOfDay.ts"
      to: "https://api.unsplash.com"
      via: "fetch with Client-ID auth header"
      pattern: "Authorization.*Client-ID"
---

<objective>
Limit BVG departures to 3 and add Unsplash landscape photos to Country of the Day panel.

Purpose: Reduce transit clutter (10 departures is too many for a glance) and make the country panel visually richer with a representative landscape photo.
Output: Modified transit API call, updated transit skeleton, new Unsplash fetch function, country image hook, updated country panel with photo + attribution.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-content-enhancements/13-RESEARCH.md
@src/lib/api/bvgTransit.ts
@src/lib/api/countryOfDay.ts
@src/hooks/useCountryOfDay.ts
@src/components/sidebar/CountryPanel.tsx
@src/components/sidebar/TransitPanel.tsx
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Limit BVG departures to 3</name>
  <files>src/lib/api/bvgTransit.ts, src/components/sidebar/TransitPanel.tsx</files>
  <action>
In `src/lib/api/bvgTransit.ts` line 21: Change `results=10` to `results=3` in the URL template string.

In `src/components/sidebar/TransitPanel.tsx` line 28: Change the skeleton loader `Array.from({ length: 5 })` to `Array.from({ length: 3 })` so the loading state matches the actual number of departures.

No other changes needed -- the departure list already maps dynamically over the array.
  </action>
  <verify>Run `grep -n 'results=' src/lib/api/bvgTransit.ts` and confirm it shows `results=3`. Run `grep -n 'length:' src/components/sidebar/TransitPanel.tsx` and confirm it shows `length: 3`.</verify>
  <done>BVG API requests exactly 3 departures. Skeleton loader shows 3 placeholder rows.</done>
</task>

<task type="auto">
  <name>Task 2: Add Unsplash country landscape photo with attribution</name>
  <files>src/lib/api/countryOfDay.ts, src/hooks/useCountryOfDay.ts, src/components/sidebar/CountryPanel.tsx</files>
  <action>
**1. Add `fetchCountryImage()` to `src/lib/api/countryOfDay.ts`:**

Add an `UnsplashPhoto` interface with fields: `url` (string), `photographer` (string), `photographerUrl` (string), `unsplashUrl` (string), `downloadLocationUrl` (string).

Add `fetchCountryImage(countryName: string): Promise<UnsplashPhoto | null>` that:
- Reads `import.meta.env.VITE_UNSPLASH_ACCESS_KEY` for the API key
- If no API key is set, return `null` immediately (graceful no-op)
- Calls `https://api.unsplash.com/search/photos?query=${encodeURIComponent(countryName + ' landscape')}&per_page=1&orientation=landscape` with header `Authorization: Client-ID ${accessKey}`
- Returns `null` if response is not ok or `data.results` is empty
- Extracts from `data.results[0]`: `urls.small` as url, `user.name` as photographer, `user.links.html` as photographerUrl, `links.html` as unsplashUrl, `links.download_location` as downloadLocationUrl
- Before returning, fires a download trigger: `fetch(photo.links.download_location, { headers: { Authorization: 'Client-ID ...' } }).catch(() => {})` (fire-and-forget, required by Unsplash API terms)
- Export both `UnsplashPhoto` type and `fetchCountryImage` function

**2. Add `useCountryImage` hook to `src/hooks/useCountryOfDay.ts`:**

Add and export `useCountryImage(countryName: string | undefined)` that uses `useQuery` with:
- `queryKey: ['country-image', countryName]`
- `queryFn: () => fetchCountryImage(countryName!)`
- `enabled: !!countryName`
- `staleTime: COUNTRY_REFRESH_MS` (import already exists)
- `refetchInterval: false`
- `retry: 1`

Import `fetchCountryImage` from the API module.

**3. Update `src/components/sidebar/CountryPanel.tsx`:**

Add a `useCountryImage` call inside `CountryPanelInner`, passing `country?.name.common`. Destructure as `{ data: countryImage }`.

Insert between the flag+name section (after the closing `</div>` of the flex items-center gap-3 mb-3 block, around line 75) and before the facts grid: a conditional block that renders when `countryImage` is truthy:
```
<div className="mb-3 rounded-lg overflow-hidden">
  <img src={countryImage.url} alt={`Landscape of ${country.name.common}`} className="w-full h-auto rounded-lg object-cover" style={{ maxHeight: 'clamp(100px, 12vw, 180px)' }} loading="eager" />
  <UnsplashAttribution photographer={countryImage.photographer} photographerUrl={countryImage.photographerUrl} unsplashUrl={countryImage.unsplashUrl} />
</div>
```

Add an `UnsplashAttribution` component (inside the same file, above CountryPanelInner) that renders:
- A `<p>` with classes `text-[clamp(8px,0.6vw,10px)] text-text-secondary mt-1`
- Text: "Photo by " + link to `{photographerUrl}?utm_source=family_dashboard&utm_medium=referral` with photographer name + " on " + link to `https://unsplash.com/?utm_source=family_dashboard&utm_medium=referral` with text "Unsplash"
- Both links: `target="_blank" rel="noopener noreferrer" className="underline"`

When there is no photo (Unsplash fails, no results, or no API key), the panel should display exactly as it does today -- flag, name, and facts grid with no image section. No error states, no broken image placeholders.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Visually verify: `grep -n 'UnsplashAttribution' src/components/sidebar/CountryPanel.tsx` shows the component definition and usage. `grep -n 'fetchCountryImage' src/lib/api/countryOfDay.ts` shows the export. `grep -n 'useCountryImage' src/hooks/useCountryOfDay.ts` shows the hook export.</verify>
  <done>Country panel displays landscape photo with proper Unsplash attribution when API key is configured and photo is available. Panel gracefully falls back to current layout when no photo available. Download trigger fires on every photo display. UTM parameters present on all attribution links.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. BVG API file contains `results=3`
4. Transit skeleton shows 3 placeholder rows
5. CountryPanel imports and uses `useCountryImage`
6. `fetchCountryImage` includes download trigger call
7. Attribution links contain `utm_source=family_dashboard`
8. No API key configured = panel renders without image (no crash)
</verification>

<success_criteria>
- BVG departures limited to exactly 3 at the API level
- Country panel shows landscape photo from Unsplash when API key is set
- Unsplash attribution visible with correct UTM parameters
- Graceful fallback when Unsplash unavailable or no results
- Download trigger fires for Unsplash analytics compliance
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/13-content-enhancements/13-01-SUMMARY.md`
</output>
