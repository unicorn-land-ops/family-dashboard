---
phase: 02-clock-weather-core
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/weather/CurrentWeather.tsx
  - src/components/weather/WeatherForecast.tsx
  - src/components/weather/SunTimes.tsx
  - src/components/weather/WeatherIcon.tsx
  - src/components/layout/Header.tsx
  - src/App.tsx
  - src/index.css
autonomous: false
requirements: [CLKW-02, CLKW-03, CLKW-04]

must_haves:
  truths:
    - "Current temperature and weather condition icon display on the dashboard"
    - "7-day forecast shows daily highs and lows with weather icons"
    - "Sunrise and sunset times display for today"
    - "Weather data refreshes every 15 minutes without page reload"
    - "Loading and error states display gracefully when weather unavailable"
  artifacts:
    - path: "src/components/weather/CurrentWeather.tsx"
      provides: "Current temp, icon, and condition description"
      exports: ["CurrentWeather"]
    - path: "src/components/weather/WeatherForecast.tsx"
      provides: "7-day forecast grid with highs/lows"
      exports: ["WeatherForecast"]
    - path: "src/components/weather/SunTimes.tsx"
      provides: "Sunrise and sunset time display"
      exports: ["SunTimes"]
    - path: "src/components/weather/WeatherIcon.tsx"
      provides: "WMO code to react-icon component mapper"
      exports: ["WeatherIcon"]
  key_links:
    - from: "src/components/weather/CurrentWeather.tsx"
      to: "src/hooks/useWeather.ts"
      via: "useWeather() hook call"
      pattern: "useWeather"
    - from: "src/components/weather/WeatherIcon.tsx"
      to: "src/lib/utils/weatherCodes.ts"
      via: "getWeatherInfo(code)"
      pattern: "getWeatherInfo"
    - from: "src/App.tsx"
      to: "src/components/weather/CurrentWeather.tsx"
      via: "component in main content area"
      pattern: "<CurrentWeather"
---

<objective>
Build weather UI components (current conditions, 7-day forecast, sunrise/sunset, icon mapper) and wire them into the dashboard layout, replacing the Weather placeholder card with live data.

Purpose: Complete the always-visible weather panel that lets the family glance at current conditions, the week ahead, and sun times. This is the second half of Phase 2, turning the data layer from Plan 01 into visible UI.

Output: Working weather display with current temp/icon, 7-day forecast, and sunrise/sunset integrated into the dashboard layout.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-clock-weather-core/02-RESEARCH.md
@.planning/phases/02-clock-weather-core/02-01-SUMMARY.md
@src/App.tsx
@src/index.css
@src/components/layout/Header.tsx
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeatherIcon, CurrentWeather, WeatherForecast, and SunTimes components</name>
  <files>
    src/components/weather/WeatherIcon.tsx
    src/components/weather/CurrentWeather.tsx
    src/components/weather/WeatherForecast.tsx
    src/components/weather/SunTimes.tsx
  </files>
  <action>
    Create `src/components/weather/WeatherIcon.tsx`:
    - Props: `{ code: number; className?: string; size?: string }`
    - Import weather icons from `react-icons/wi`: WiDaySunny, WiDayCloudy, WiCloudy, WiFog, WiSprinkle, WiRain, WiRainWind, WiRainMix, WiSnow, WiShowers, WiThunderstorm, WiStormShowers, WiNa
    - Create a Record mapping icon string names (from weatherCodes.ts getWeatherInfo) to React icon components
    - Use `getWeatherInfo(code)` to look up the icon name, then render the mapped component
    - Default to WiNa for unknown codes
    - Pass className and size through to the icon component

    Create `src/components/weather/CurrentWeather.tsx`:
    - Uses `useWeather()` hook
    - Wrapped in `React.memo` to prevent re-renders from clock (per research pitfall 1)
    - Layout: horizontal flex with icon on left, temp + description on right
    - Temperature: `Math.round(data.current.temperature_2m)` with "°C" suffix
    - Use `WeatherIcon` component with the current weather code
    - Temperature text: large fluid size `clamp(1.5rem, 3vw, 3rem)`, font-bold, tabular-nums
    - Description text: smaller, text-text-secondary
    - Loading state: subtle skeleton/text "Loading..." in text-text-secondary
    - Error state: "Weather unavailable" in text-text-secondary (graceful degradation, not alarming)

    Create `src/components/weather/WeatherForecast.tsx`:
    - Uses `useWeather()` hook
    - Wrapped in `React.memo`
    - Layout: horizontal grid/flex showing 7 days
    - Each day column shows:
      - Day name abbreviated (Mon, Tue...) using `format(parseISO(date), 'EEE')` from date-fns
      - WeatherIcon for that day's weather code (smaller size)
      - High temp in bold
      - Low temp in text-text-secondary, smaller
    - Today (index 0) should be visually distinguished (e.g., accent-gold text for day name, or subtle bg highlight)
    - On mobile (portrait), consider showing fewer days (5) or using a scrollable horizontal layout. Use Tailwind responsive classes.
    - Loading/error: return null (forecast is secondary to current weather)

    Create `src/components/weather/SunTimes.tsx`:
    - Uses `useWeather()` hook
    - Wrapped in `React.memo`
    - Shows today's sunrise and sunset (index 0 from daily arrays)
    - Format times using `formatInTimeZone` or parse the ISO string and format as `HH:mm`
    - Layout: compact horizontal with sunrise icon (WiSunrise from react-icons/wi) + time, sunset icon (WiSunset) + time
    - Use text-text-secondary for labels, text-accent-gold for the sun icons
    - Loading/error: return null
  </action>
  <verify>
    Run `npm run build` — all 4 components compile without TypeScript errors.
    Verify files exist: `ls src/components/weather/WeatherIcon.tsx src/components/weather/CurrentWeather.tsx src/components/weather/WeatherForecast.tsx src/components/weather/SunTimes.tsx`
  </verify>
  <done>
    Four weather components created: WeatherIcon maps WMO codes to react-icons, CurrentWeather shows temp + icon + description, WeatherForecast shows 7-day grid, SunTimes shows sunrise/sunset. All use useWeather hook and are wrapped in React.memo. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire weather components into dashboard layout and add current weather to Header</name>
  <files>
    src/components/layout/Header.tsx
    src/App.tsx
    src/index.css
  </files>
  <action>
    Update `src/components/layout/Header.tsx`:
    - Add current weather summary to the right side of the header (the header already uses `flex justify-between`)
    - Import and render `CurrentWeather` on the right side: `<div className="flex items-center"><CurrentWeather /></div>`
    - This puts clock/date on left, current temp/icon on right — visible at a glance from both kiosk and mobile

    Update `src/App.tsx`:
    - Replace the Weather placeholder card in the main content area with actual weather components
    - Replace: `<div className="card-glass ..."><span>Weather</span></div>`
    - With a card containing `WeatherForecast` and `SunTimes`:
      ```
      <div className="card-glass p-[clamp(16px,2vw,32px)]">
        <WeatherForecast />
        <SunTimes />  {/* Below forecast, separated by margin */}
      </div>
      ```
    - Keep the Calendar placeholder card below it
    - Import all weather components at the top of the file

    Update `src/index.css` if needed:
    - Add any weather-specific utility classes if Tailwind doesn't cover the layout needs
    - Potentially add a `.forecast-grid` class if the 7-day grid needs custom column sizing
    - Keep minimal — prefer Tailwind classes in components
  </action>
  <verify>
    Run `npm run build` — no errors. Run `npm run dev` and verify:
    - Header shows clock on left, current weather (temp + icon) on right
    - Main content area shows 7-day forecast with day names, icons, highs/lows
    - Sunrise/sunset times display below forecast
    - On mobile viewport (Chrome DevTools responsive mode), layout remains readable
    - Weather data loads after brief loading state
    - No console errors
  </verify>
  <done>
    Weather components wired into dashboard. Header shows current temp + icon alongside clock. Main area shows 7-day forecast and sunrise/sunset. Weather data fetches from Open-Meteo and auto-refreshes every 15 minutes. Layout is responsive.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify clock and weather display</name>
  <files>src/App.tsx</files>
  <action>
Human verification checkpoint. What was built:
- Real-time Berlin clock with date-fns-tz formatting (upgraded from Intl API)
- Current weather (temperature + icon + description) in header right side
- 7-day forecast with daily highs/lows and weather icons in main content area
- Sunrise and sunset times for today below forecast
- Auto-refreshing weather data via React Query (5-min stale, 15-min refetch)

How to verify:
1. Run `npm run dev` and open http://localhost:5173/family-dashboard/
2. Verify clock shows current Berlin time and updates every second
3. Verify date shows in English format (e.g., "Monday, February 16, 2026")
4. Verify current weather appears in the header with temperature and icon
5. Verify 7-day forecast grid shows day names, icons, highs and lows
6. Verify sunrise and sunset times display (check against timeanddate.com for Berlin)
7. Open Chrome DevTools, switch to iPhone viewport — verify layout is readable
8. Open Network tab — confirm fetch to api.open-meteo.com returns 200
9. Wait 1 minute — verify no console errors or memory warnings
  </action>
  <verify>User confirms clock accuracy, weather data display, responsive layout, and overall visual quality</verify>
  <done>Clock shows Berlin time, weather panel shows current conditions + 7-day forecast + sunrise/sunset, layout works on kiosk and mobile viewports, user approves visual quality</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Clock shows Berlin time, ticks every second
3. Current weather shows real temperature from Open-Meteo
4. 7-day forecast displays with correct day names and temperatures
5. Sunrise/sunset times match Berlin reality (verify against external source)
6. Weather refreshes automatically (visible in Network tab after 15 minutes, or force by changing staleTime temporarily)
7. Layout works in both landscape (kiosk) and portrait (mobile) viewports
8. No console errors
9. Loading states display gracefully before weather data arrives
</verification>

<success_criteria>
- Current weather (temp + icon + description) visible in dashboard header
- 7-day forecast with daily highs, lows, and weather icons visible in main content area
- Sunrise and sunset times for Berlin display correctly
- Weather data refreshes every 15 minutes via React Query
- All components wrapped in React.memo to prevent clock re-render cascade
- Layout responsive on both kiosk (landscape) and mobile (portrait) viewports
- Graceful loading and error states (not jarring or alarming)
</success_criteria>

<output>
After completion, create `.planning/phases/02-clock-weather-core/02-02-SUMMARY.md`
</output>
