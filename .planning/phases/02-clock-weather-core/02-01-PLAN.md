---
phase: 02-clock-weather-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useInterval.ts
  - src/hooks/useClock.ts
  - src/hooks/useWeather.ts
  - src/lib/api/openMeteo.ts
  - src/lib/utils/weatherCodes.ts
  - src/lib/utils/timeFormat.ts
  - src/components/clock/Clock.tsx
  - src/components/clock/DateDisplay.tsx
  - src/components/layout/Header.tsx
  - src/App.tsx
  - src/main.tsx
  - package.json
autonomous: true
requirements: [CLKW-01, CLKW-02]

must_haves:
  truths:
    - "Clock displays current Berlin time updating every second"
    - "Date displays in English long format (e.g., Monday, February 16, 2026) in Berlin timezone"
    - "Weather data fetches from Open-Meteo API and caches with React Query"
    - "Current temperature and weather code are available to UI components"
  artifacts:
    - path: "src/hooks/useInterval.ts"
      provides: "Dan Abramov useInterval hook with cleanup"
      exports: ["useInterval"]
    - path: "src/hooks/useClock.ts"
      provides: "Berlin timezone clock state with formatted time and date"
      exports: ["useClock"]
    - path: "src/hooks/useWeather.ts"
      provides: "React Query wrapper for weather data"
      exports: ["useWeather"]
    - path: "src/lib/api/openMeteo.ts"
      provides: "Open-Meteo API fetch with TypeScript types"
      exports: ["fetchWeather", "WeatherResponse"]
    - path: "src/lib/utils/weatherCodes.ts"
      provides: "WMO weather code to description and icon mapping"
      exports: ["getWeatherInfo", "WMO_CODES"]
    - path: "src/components/clock/Clock.tsx"
      provides: "Real-time clock display component"
      exports: ["Clock"]
    - path: "src/components/clock/DateDisplay.tsx"
      provides: "Current date display component"
      exports: ["DateDisplay"]
  key_links:
    - from: "src/hooks/useClock.ts"
      to: "src/hooks/useInterval.ts"
      via: "useInterval(callback, 1000)"
      pattern: "useInterval"
    - from: "src/hooks/useWeather.ts"
      to: "src/lib/api/openMeteo.ts"
      via: "queryFn: fetchWeather"
      pattern: "fetchWeather"
    - from: "src/App.tsx"
      to: "@tanstack/react-query"
      via: "QueryClientProvider wrapping app"
      pattern: "QueryClientProvider"
---

<objective>
Install dependencies, create clock/weather hooks and API layer, upgrade Header to use isolated clock components with date-fns-tz, and set up React Query for weather data fetching.

Purpose: Establish the data infrastructure (hooks, API client, WMO codes) and upgrade the existing clock to use proper timezone-aware formatting with date-fns-tz. This foundation enables Plan 02 to build weather UI components without any data plumbing.

Output: Working clock with date-fns-tz formatting, weather data fetching via React Query, WMO code mapping, all hooks and types ready for UI consumption.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-clock-weather-core/02-RESEARCH.md
@.planning/phases/01-foundation-setup/01-02-SUMMARY.md
@src/App.tsx
@src/main.tsx
@src/lib/constants.ts
@src/components/layout/Header.tsx
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create data layer (hooks, API, utils)</name>
  <files>
    package.json
    src/hooks/useInterval.ts
    src/hooks/useClock.ts
    src/hooks/useWeather.ts
    src/lib/api/openMeteo.ts
    src/lib/utils/weatherCodes.ts
    src/lib/utils/timeFormat.ts
  </files>
  <action>
    Install dependencies:
    ```
    npm install @tanstack/react-query date-fns date-fns-tz react-icons
    ```

    Create `src/hooks/useInterval.ts` — Dan Abramov's useInterval pattern:
    - Takes `callback: () => void` and `delay: number | null`
    - Uses `useRef` to store latest callback (avoids stale closures)
    - `useEffect` with `setInterval` that reads from ref, cleanup on unmount
    - Pass `null` for delay to pause the interval

    Create `src/lib/utils/timeFormat.ts` — Timezone formatting helpers:
    - Import `formatInTimeZone` from `date-fns-tz`
    - Export `TIMEZONE = 'Europe/Berlin'` constant (keep existing from constants.ts too for backward compat)
    - Export `formatBerlinTime(date: Date): string` — returns `HH:mm` format (no seconds, cleaner for dashboard)
    - Export `formatBerlinTimeWithSeconds(date: Date): string` — returns `HH:mm:ss` for when seconds needed
    - Export `formatBerlinDate(date: Date): string` — returns `EEEE, MMMM d, yyyy` format in English
    - Export `formatBerlinDateShort(date: Date): string` — returns `EEE, MMM d` short format

    Create `src/hooks/useClock.ts`:
    - Uses `useInterval` with 1000ms delay
    - State: single `Date` object updated every second via `useState(new Date())`
    - Returns `{ time, date, dateShort }` using timeFormat helpers
    - Clock state is isolated to this hook (prevents re-render cascade per research pitfall 1)

    Create `src/lib/api/openMeteo.ts`:
    - Define `WeatherResponse` interface matching Open-Meteo response shape:
      ```
      current: { time: string; temperature_2m: number; weather_code: number }
      daily: { time: string[]; temperature_2m_max: number[]; temperature_2m_min: number[]; weather_code: number[]; sunrise: string[]; sunset: string[] }
      timezone: string
      ```
    - Constants: `BERLIN_LAT = 52.52`, `BERLIN_LON = 13.419`
    - Export `fetchWeather(): Promise<WeatherResponse>` — builds URLSearchParams with:
      - latitude, longitude
      - `current=temperature_2m,weather_code`
      - `daily=temperature_2m_max,temperature_2m_min,weather_code,sunrise,sunset`
      - `timezone=Europe/Berlin`
      - `forecast_days=7`
    - Fetches from `https://api.open-meteo.com/v1/forecast`
    - Throws on non-ok response with status code in message

    Create `src/hooks/useWeather.ts`:
    - Wraps `useQuery` from React Query
    - `queryKey: ['weather', 'berlin']`
    - `queryFn: fetchWeather`
    - `staleTime: 5 * 60 * 1000` (5 minutes)
    - `refetchInterval: 15 * 60 * 1000` (15 minutes)
    - `refetchOnWindowFocus: true`
    - `retry: 3`
    - Returns the useQuery result directly

    Create `src/lib/utils/weatherCodes.ts`:
    - Define complete WMO code mapping (codes 0-99) with `description` and `icon` string fields
    - Icon strings map to react-icons/wi component names: WiDaySunny, WiCloudy, WiFog, WiRain, WiSnow, WiThunderstorm, etc.
    - Full mapping:
      - 0: Clear sky (WiDaySunny)
      - 1: Mainly clear (WiDaySunny)
      - 2: Partly cloudy (WiDayCloudy)
      - 3: Overcast (WiCloudy)
      - 45, 48: Fog (WiFog)
      - 51, 53, 55: Drizzle light/moderate/dense (WiSprinkle, WiSprinkle, WiRain)
      - 56, 57: Freezing drizzle (WiRainMix)
      - 61, 63, 65: Rain light/moderate/heavy (WiRain, WiRain, WiRainWind)
      - 66, 67: Freezing rain (WiRainMix)
      - 71, 73, 75: Snow light/moderate/heavy (WiSnow, WiSnow, WiSnow)
      - 77: Snow grains (WiSnow)
      - 80, 81, 82: Rain showers (WiShowers, WiShowers, WiRainWind)
      - 85, 86: Snow showers (WiSnow)
      - 95: Thunderstorm (WiThunderstorm)
      - 96, 99: Thunderstorm with hail (WiStormShowers)
    - Export `getWeatherInfo(code: number)` — returns `{ description, icon }`, falls back to `{ description: 'Unknown', icon: 'WiNa' }` for unmapped codes
    - Export type `WeatherInfo = { description: string; icon: string }`
  </action>
  <verify>
    Run `npm run build` — project compiles without errors. Verify all 6 new files exist:
    - `ls src/hooks/useInterval.ts src/hooks/useClock.ts src/hooks/useWeather.ts`
    - `ls src/lib/api/openMeteo.ts src/lib/utils/weatherCodes.ts src/lib/utils/timeFormat.ts`
  </verify>
  <done>
    All dependencies installed. useInterval, useClock, useWeather hooks export correctly. openMeteo.ts fetches weather data with proper types. weatherCodes.ts maps all WMO codes. timeFormat.ts formats Berlin time/date. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade Header with Clock/DateDisplay components and wire React Query</name>
  <files>
    src/components/clock/Clock.tsx
    src/components/clock/DateDisplay.tsx
    src/components/layout/Header.tsx
    src/App.tsx
    src/main.tsx
  </files>
  <action>
    Create `src/components/clock/Clock.tsx`:
    - Uses `useClock` hook for time string
    - Renders time in large fluid typography: `text-text-primary font-extralight tracking-tight leading-none` with `style={{ fontSize: 'clamp(2rem, 6vw, 6rem)' }}` (matching existing Header style)
    - Uses `tabular-nums` for consistent digit width (prevents layout shifts)
    - Component is self-contained — only re-renders when its own time state changes

    Create `src/components/clock/DateDisplay.tsx`:
    - Uses `useClock` hook for date string
    - Renders date in smaller text: `text-text-secondary font-normal mt-1` with `style={{ fontSize: 'clamp(0.875rem, 1.2vw, 1.25rem)' }}`
    - NOTE: This will re-render every second due to shared `useClock` hook with Clock. This is acceptable since the date component is lightweight. If performance is a concern later, a separate `useDate` hook with 60s interval could be created.

    Update `src/components/layout/Header.tsx`:
    - Replace inline clock logic (useState, useEffect, getFormattedTime, getFormattedDate) with Clock and DateDisplay components
    - Keep the same layout structure: `<header className="grid-area-header ..."><div><Clock /><DateDisplay /></div></header>`
    - Remove imports for useState, useEffect, TIMEZONE, CLOCK_INTERVAL_MS (no longer needed)
    - The right side of the header will remain empty for now — weather summary will be added there in Plan 02

    Update `src/main.tsx`:
    - Import `QueryClient` and `QueryClientProvider` from `@tanstack/react-query`
    - Create `queryClient` instance with default options:
      ```
      defaultOptions: { queries: { refetchOnWindowFocus: true, retry: 3 } }
      ```
    - Wrap `<App />` in `<QueryClientProvider client={queryClient}>`
    - This is done in main.tsx (not App.tsx) so QueryClient lives at the root and survives App re-renders

    No changes to `src/App.tsx` in this task — weather components are added in Plan 02.
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors. Run `npm run dev` and verify in browser:
    - Clock displays current Berlin time with updating seconds
    - Date displays in English format (e.g., "Monday, February 16, 2026")
    - No console errors about React Query or missing providers
  </verify>
  <done>
    Header uses Clock and DateDisplay components backed by useClock/useInterval hooks with date-fns-tz. React Query provider wraps the app in main.tsx. Build passes. Clock ticks every second with Berlin timezone. Date shows English long format.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` — clock shows Berlin time, updates every second
3. Date shows English format like "Monday, February 16, 2026"
4. React Query devtools (if enabled) shows no errors
5. No console warnings about missing QueryClient provider
6. `tabular-nums` prevents clock digit layout shifts
</verification>

<success_criteria>
- Clock displays Berlin time with date-fns-tz formatting (not Intl API as before)
- useInterval hook handles cleanup correctly (no memory leaks)
- Weather API layer (openMeteo.ts) exports typed fetchWeather function
- useWeather hook wraps React Query with 5min stale / 15min refetch
- WMO codes fully mapped for all Open-Meteo weather conditions
- React Query provider configured at app root
- Build succeeds with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-clock-weather-core/02-01-SUMMARY.md`
</output>
