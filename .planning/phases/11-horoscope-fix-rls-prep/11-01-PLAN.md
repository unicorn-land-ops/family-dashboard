---
phase: 11-horoscope-fix-rls-prep
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cloudflare-worker/cors-proxy.js
  - cloudflare-worker/wrangler.toml
  - src/lib/api/horoscope.ts
  - src/hooks/useHoroscope.ts
  - src/components/sidebar/HoroscopePanel.tsx
  - src/lib/constants.ts
  - supabase/rls-policies.sql
autonomous: false
requirements:
  - FIX-01
user_setup:
  - service: api-ninjas
    why: "Horoscope API data source"
    env_vars:
      - name: API_NINJAS_KEY
        source: "https://api-ninjas.com â€” sign up, copy API key from dashboard"
    dashboard_config:
      - task: "Set Worker secret"
        location: "Run: cd cloudflare-worker && npx wrangler secret put API_NINJAS_KEY"

must_haves:
  truths:
    - "Horoscope panel displays daily readings for Capricorn, Aquarius, and Sagittarius"
    - "Each horoscope shows zodiac emoji only as heading (no name, no person)"
    - "Horoscopes fetch once daily via Cloudflare Worker proxy (API key stays server-side)"
    - "When API is down and no cache exists, horoscope panel hides entirely"
    - "Supabase RLS policies allow anon CRUD on groceries and timers tables"
    - "Row count guardrails prevent spam (100 groceries, 10 active timers)"
  artifacts:
    - path: "cloudflare-worker/cors-proxy.js"
      provides: "Horoscope proxy route with API Ninjas key injection"
      contains: "/horoscope"
    - path: "src/lib/api/horoscope.ts"
      provides: "Fetch function using Worker proxy endpoint"
      contains: "/horoscope?sign="
    - path: "src/components/sidebar/HoroscopePanel.tsx"
      provides: "Emoji-only headings, hide-on-error behavior"
      contains: "ZODIAC_EMOJI"
    - path: "supabase/rls-policies.sql"
      provides: "RLS policy SQL for groceries and timers"
      contains: "ENABLE ROW LEVEL SECURITY"
  key_links:
    - from: "src/lib/api/horoscope.ts"
      to: "cloudflare-worker/cors-proxy.js"
      via: "fetch to CORS_PROXY_URL/horoscope"
      pattern: "CORS_PROXY_URL.*horoscope"
    - from: "cloudflare-worker/cors-proxy.js"
      to: "api.api-ninjas.com"
      via: "server-side fetch with X-Api-Key header"
      pattern: "api-ninjas\\.com.*horoscope"
    - from: "src/hooks/useHoroscope.ts"
      to: "src/lib/constants.ts"
      via: "24h staleTime from HOROSCOPE_REFRESH_MS"
      pattern: "HOROSCOPE_REFRESH_MS"
---

<objective>
Replace the broken ohmanda.com horoscope API with API Ninjas via the existing Cloudflare Worker proxy, update the horoscope panel to show emoji-only headings, and create Supabase RLS policies on groceries and timers tables for anon CRUD access.

Purpose: Family sees daily horoscope readings again, and Supabase is ready for external writes (Phase 15 Siri integration).
Output: Updated Worker proxy, frontend horoscope integration, RLS policy SQL file, deployed and verified.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-horoscope-fix-rls-prep/11-RESEARCH.md
@.planning/phases/11-horoscope-fix-rls-prep/11-CONTEXT.md
@cloudflare-worker/cors-proxy.js
@cloudflare-worker/wrangler.toml
@src/lib/api/horoscope.ts
@src/hooks/useHoroscope.ts
@src/components/sidebar/HoroscopePanel.tsx
@src/lib/constants.ts
@src/lib/calendar/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Horoscope API migration and panel update</name>
  <files>
    cloudflare-worker/cors-proxy.js
    cloudflare-worker/wrangler.toml
    src/lib/api/horoscope.ts
    src/hooks/useHoroscope.ts
    src/components/sidebar/HoroscopePanel.tsx
    src/lib/constants.ts
    supabase/rls-policies.sql
  </files>
  <action>
    **1. Extend Cloudflare Worker with /horoscope route** (`cloudflare-worker/cors-proxy.js`):
    - Add route matching: if `url.pathname === '/horoscope'`, call `handleHoroscope(url, env)`
    - `handleHoroscope` extracts `sign` query param, fetches `https://api.api-ninjas.com/v1/horoscope?sign=${sign}` with `X-Api-Key: env.API_NINJAS_KEY` header
    - Return JSON response with CORS headers and `Cache-Control: public, max-age=86400` (24h)
    - Handle missing sign param (400), missing API key (500 with message), upstream errors (pass status)
    - Keep existing calendar proxy logic unchanged (the `?url=` route)
    - Update the JSDoc comment at top to mention horoscope proxy too

    **2. Update wrangler.toml** (`cloudflare-worker/wrangler.toml`):
    - No code changes needed for secrets (they are set via `wrangler secret put`, not in toml)
    - But rename to reflect broader purpose: keep name as `family-cal-proxy` (changing would break deployed URL)

    **3. Update horoscope fetch function** (`src/lib/api/horoscope.ts`):
    - Change `HOROSCOPE_BASE` from `https://ohmanda.com/api/horoscope` to use `CORS_PROXY_URL` from `../calendar/config`
    - Import `CORS_PROXY_URL` from `../calendar/config`
    - Build URL as `${CORS_PROXY_URL.replace(/\/$/, '')}/horoscope?sign=${sign}`
    - Map API Ninjas response shape: field is `zodiac` not `sign`, so map `sign: data.zodiac`
    - Remove `SIGN_LABELS` export entirely (no longer needed -- per user decision, no person names)
    - Keep `FAMILY_SIGNS`, `ZodiacSign`, `HoroscopeData` types unchanged

    **4. Update horoscope hook** (`src/hooks/useHoroscope.ts`):
    - `staleTime` and `refetchInterval` already use `HOROSCOPE_REFRESH_MS` -- no code change needed after constants update
    - Add `gcTime: HOROSCOPE_REFRESH_MS` so cached data persists for 24h (keeps data available if API goes down)

    **5. Update HoroscopePanel** (`src/components/sidebar/HoroscopePanel.tsx`):
    - Remove `SIGN_LABELS` import (deleted from horoscope.ts)
    - Show emoji only as heading per sign: remove the `{label}` span, keep only the emoji span. Make emoji `text-base` size
    - On error with no data (`error || !horoscopes?.length`): return `null` instead of the "Horoscopes unavailable" fallback (per user decision: hide panel entirely)
    - Keep loading skeleton unchanged
    - Increase `line-clamp` from 3 to 4 for slightly more text per reading (Claude's discretion on text length)

    **6. Update constants** (`src/lib/constants.ts`):
    - Change `HOROSCOPE_REFRESH_MS` from `6 * 60 * 60 * 1000` (6h) to `24 * 60 * 60 * 1000` (24h)

    **7. Create RLS policy SQL file** (`supabase/rls-policies.sql`):
    - Create new file documenting the exact SQL to run in Supabase SQL Editor
    - Include policies for both groceries and timers tables:
      - SELECT: `USING (true)` for anon on both tables
      - INSERT: `WITH CHECK ((SELECT count(*) FROM groceries) < 100)` for groceries, `WITH CHECK ((SELECT count(*) FROM timers WHERE cancelled = false) < 10)` for timers
      - UPDATE: `USING (true) WITH CHECK (true)` for anon on both tables
      - DELETE: `USING (true)` for anon on both tables
    - CRITICAL ordering: Create ALL policies FIRST in a single transaction, THEN enable RLS. Wrap in BEGIN/COMMIT
    - Add header comment explaining these policies and the row count guardrails
    - Add verification queries at the bottom (SET ROLE anon; test INSERT/SELECT/UPDATE/DELETE; RESET ROLE)
  </action>
  <verify>
    - `npm run build` passes (TypeScript compiles, no broken imports)
    - `grep -r "ohmanda" src/` returns no results (old API fully removed)
    - `grep "SIGN_LABELS" src/components/` returns no results (labels removed from panel)
    - `supabase/rls-policies.sql` exists and contains ENABLE ROW LEVEL SECURITY for both tables
  </verify>
  <done>
    All code changes committed: Worker has /horoscope route, frontend fetches via proxy, panel shows emoji-only headings, panel hides on error, 24h cache, RLS SQL documented.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Deploy Worker, set secret, apply RLS, and verify</name>
  <files>
    cloudflare-worker/cors-proxy.js
    supabase/rls-policies.sql
  </files>
  <action>
    This is a human verification checkpoint. Task 1 created all code changes. The user now needs to deploy the Worker, set the API secret, apply RLS policies, and verify the full integration works end-to-end.
  </action>
  <verify>
    **Step 1: Set Worker secret and deploy**
    ```bash
    cd cloudflare-worker
    npx wrangler secret put API_NINJAS_KEY
    # Paste your API Ninjas key when prompted
    npx wrangler deploy
    ```

    **Step 2: Test the Worker proxy**
    ```bash
    curl "https://family-cal-proxy.<your-subdomain>.workers.dev/horoscope?sign=capricorn"
    ```
    Expected: JSON with `{ date, zodiac, horoscope }` fields

    **Step 3: Apply RLS policies in Supabase**
    - Open Supabase Dashboard > SQL Editor
    - Copy contents of `supabase/rls-policies.sql`
    - Run the full script (it creates policies and enables RLS in a transaction)

    **Step 4: Verify RLS with test queries**
    Run the verification queries at the bottom of `rls-policies.sql` in the SQL Editor:
    - `SET ROLE anon; SELECT * FROM groceries LIMIT 5;` -- should return rows
    - `INSERT INTO groceries (name, checked) VALUES ('test-rls', false);` -- should succeed
    - `UPDATE groceries SET checked = true WHERE name = 'test-rls';` -- should succeed
    - `DELETE FROM groceries WHERE name = 'test-rls';` -- should succeed
    - Repeat for timers table
    - `RESET ROLE;`

    **Step 5: Verify dashboard**
    - Open the dashboard in a browser
    - Wait for sidebar to rotate to horoscope panel
    - Confirm: 3 zodiac readings displayed with emoji-only headings
    - Confirm: grocery list and timers still work normally (RLS did not break existing functionality)
  </verify>
  <done>
    Worker deployed with horoscope proxy route, API Ninjas key set as secret, RLS policies active on groceries and timers tables, anon CRUD verified, dashboard shows horoscope readings.
  </done>
</task>

</tasks>

<verification>
- Horoscope panel shows 3 zodiac readings with emoji headings (no person names)
- API Ninjas key is server-side only (not in any VITE_ env var or client bundle)
- Horoscope data caches for 24 hours (React Query staleTime + Worker Cache-Control)
- Panel hides completely when API is down and no cached data exists
- Groceries table: anon can SELECT, INSERT (up to 100), UPDATE, DELETE
- Timers table: anon can SELECT, INSERT (up to 10 active), UPDATE, DELETE
- Existing dashboard functionality (groceries, timers, calendar) unaffected by RLS changes
</verification>

<success_criteria>
- `npm run build` succeeds
- Worker deployed with /horoscope route returning API Ninjas data
- Dashboard shows horoscope readings for Capricorn, Aquarius, Sagittarius
- RLS policies active on groceries and timers tables
- Anon CRUD verified with test queries in Supabase
</success_criteria>

<output>
After completion, create `.planning/phases/11-horoscope-fix-rls-prep/11-01-SUMMARY.md`
</output>
