---
phase: 06-grocery-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/api/groceries.ts
  - src/hooks/useGroceries.ts
autonomous: true
requirements: [GROC-01, GROC-02, GROC-03]

must_haves:
  truths:
    - "Grocery CRUD functions call Supabase with correct table and operations"
    - "useGroceries hook provides query data, addItem, toggleItem, removeItem, clearChecked"
    - "Optimistic updates give instant feedback before server confirms"
    - "Realtime subscription invalidates cache when another device changes data"
    - "All functions gracefully return empty/no-op when Supabase is not configured"
  artifacts:
    - path: "src/lib/api/groceries.ts"
      provides: "Supabase CRUD functions for groceries table"
      exports: ["fetchGroceries", "addGrocery", "toggleGrocery", "removeGrocery", "clearCheckedGroceries"]
    - path: "src/hooks/useGroceries.ts"
      provides: "React Query hook with optimistic mutations and realtime sync"
      exports: ["useGroceries"]
  key_links:
    - from: "src/hooks/useGroceries.ts"
      to: "src/lib/api/groceries.ts"
      via: "import for queryFn and mutationFn"
      pattern: "import.*from.*api/groceries"
    - from: "src/hooks/useGroceries.ts"
      to: "src/hooks/useSupabaseRealtime.ts"
      via: "realtime subscription for cache invalidation"
      pattern: "useSupabaseRealtime.*groceries"
    - from: "src/hooks/useGroceries.ts"
      to: "@tanstack/react-query"
      via: "useQuery + useMutation with optimistic updates"
      pattern: "useMutation.*onMutate"
---

<objective>
Create the grocery list data layer: Supabase CRUD functions and a useGroceries React Query hook with optimistic mutations and realtime cache invalidation.

Purpose: Provides the complete data backbone for the grocery feature -- all UI components in Plan 02 will consume this single hook.
Output: `src/lib/api/groceries.ts` (CRUD functions), `src/hooks/useGroceries.ts` (hook)
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-grocery-list/06-RESEARCH.md
@.planning/phases/05-realtime-infrastructure/05-01-SUMMARY.md
@.planning/phases/05-realtime-infrastructure/05-02-SUMMARY.md
@src/lib/supabase.ts
@src/types/database.ts
@src/hooks/useSupabaseRealtime.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase grocery CRUD functions</name>
  <files>src/lib/api/groceries.ts</files>
  <action>
Create `src/lib/api/groceries.ts` with 5 exported async functions that operate against the `groceries` Supabase table. Import `supabase` from `../supabase` and `Grocery` type from `../../types/database`.

Functions:
1. `fetchGroceries(): Promise<Grocery[]>` -- Select all rows, ordered by `checked ASC, created_at DESC` (unchecked first, newest first). Return `[]` if supabase is null.
2. `addGrocery(name: string, addedBy?: string): Promise<void>` -- Insert `{ name, checked: false, added_by: addedBy ?? null }`. Throw if supabase null.
3. `toggleGrocery(id: string, checked: boolean): Promise<void>` -- Update `{ checked, updated_at: new Date().toISOString() }` where id matches. Throw if supabase null.
4. `removeGrocery(id: string): Promise<void>` -- Delete where id matches. Throw if supabase null.
5. `clearCheckedGroceries(): Promise<void>` -- Delete where `checked = true`. Throw if supabase null.

All functions that throw on null supabase should throw `new Error('Supabase not configured')`. All functions that call supabase should check the `error` property of the response and `throw error` if present.

Follow the exact patterns from 06-RESEARCH.md Code Examples section.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors in the new file.</verify>
  <done>Five exported CRUD functions exist with proper Supabase queries, null guards, and error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Create useGroceries hook with optimistic mutations and realtime sync</name>
  <files>src/hooks/useGroceries.ts</files>
  <action>
Create `src/hooks/useGroceries.ts` exporting a single `useGroceries()` hook. Import from `@tanstack/react-query`, `../lib/supabase` (for `supabaseEnabled`), `../lib/api/groceries` (CRUD functions), `./useSupabaseRealtime`, and `../types/database` (Grocery type).

**Query:**
- `queryKey: ['groceries']`
- `queryFn: fetchGroceries`
- `enabled: supabaseEnabled`
- `staleTime: 30_000`

**Realtime subscription:**
- Call `useSupabaseRealtime({ table: 'groceries', onPayload: () => queryClient.invalidateQueries({ queryKey: ['groceries'] }) })`
- This ensures changes from other devices trigger a cache refresh.

**Mutations (all three follow the same optimistic pattern):**

`addItem` (useMutation):
- `mutationFn`: calls `addGrocery(name)`
- `onMutate`: cancel queries, snapshot previous data, insert optimistic Grocery object at start of array (id from `crypto.randomUUID()`, checked: false, timestamps from `new Date().toISOString()`)
- `onError`: rollback to previous snapshot
- `onSettled`: invalidate queries

`toggleItem` (useMutation):
- `mutationFn`: calls `toggleGrocery(id, checked)`
- `onMutate`: cancel queries, snapshot, map over items flipping the `checked` field for matching id
- `onError`: rollback
- `onSettled`: invalidate

`removeItem` (useMutation):
- `mutationFn`: calls `removeGrocery(id)`
- `onMutate`: cancel queries, snapshot, filter out item with matching id
- `onError`: rollback
- `onSettled`: invalidate

`clearChecked` (useMutation):
- `mutationFn`: calls `clearCheckedGroceries()`
- `onMutate`: cancel queries, snapshot, filter out all checked items
- `onError`: rollback
- `onSettled`: invalidate

**Return object:**
```typescript
{
  items: query.data ?? [],
  isLoading: query.isLoading,
  error: query.error,
  addItem: (name: string) => addItem.mutate(name),
  toggleItem: (id: string, checked: boolean) => toggleItem.mutate({ id, checked }),
  removeItem: (id: string) => removeItem.mutate(id),
  clearChecked: () => clearChecked.mutate(),
  uncheckedCount: (query.data ?? []).filter(g => !g.checked).length,
}
```

Follow the exact optimistic update patterns from 06-RESEARCH.md Pattern 2. Ensure the onMutate context type includes `{ previous: Grocery[] | undefined }` for proper rollback typing.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- builds successfully.</verify>
  <done>useGroceries hook exports with query, 4 mutations (add/toggle/remove/clearChecked), realtime invalidation, and computed uncheckedCount. All optimistic with rollback.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- `src/lib/api/groceries.ts` exports 5 functions
- `src/hooks/useGroceries.ts` exports useGroceries returning items, mutations, and uncheckedCount
- No new dependencies added to package.json
</verification>

<success_criteria>
Complete grocery data layer: CRUD functions + React Query hook with optimistic updates + realtime sync. Ready for UI components to consume via `useGroceries()`.
</success_criteria>

<output>
After completion, create `.planning/phases/06-grocery-list/06-01-SUMMARY.md`
</output>
