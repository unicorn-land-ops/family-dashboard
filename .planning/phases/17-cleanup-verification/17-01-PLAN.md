---
phase: 17-cleanup-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/schema.sql
  - src/components/sidebar/CountryPanel.tsx
  - .planning/REQUIREMENTS.md
autonomous: false
requirements:
  - FIX-02
  - CALL-01
  - CALL-02

must_haves:
  truths:
    - "Supabase groceries and timers tables have only anon_* guardrail policies (no 'Allow all' bypass)"
    - "schema.sql matches production RLS state (no 'Allow all' on groceries/timers)"
    - "CountryPanel.tsx has no unused props in UnsplashAttribution"
    - "REQUIREMENTS.md shows SIRI-02 as satisfied with correct traceability"
    - "Calendar emojis display correctly and weather sits under day header (user-verified)"
  artifacts:
    - path: "supabase/schema.sql"
      provides: "Updated RLS policies matching production"
      contains: "anon_select_groceries"
    - path: "src/components/sidebar/CountryPanel.tsx"
      provides: "Clean UnsplashAttribution component"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Accurate completion status"
      contains: "[x] **SIRI-02**"
  key_links:
    - from: "supabase/schema.sql"
      to: "supabase/rls-policies.sql"
      via: "schema.sql now includes guardrail policies instead of Allow all"
      pattern: "anon_insert_groceries"

user_setup:
  - service: supabase
    why: "Drop conflicting RLS policies from live database"
    dashboard_config:
      - task: "Run SQL to verify existing policies, then drop 'Allow all' on groceries and timers"
        location: "Supabase Dashboard > SQL Editor"
---

<objective>
Clean up Supabase RLS policy conflicts, fix dead code in CountryPanel, update docs to reflect completion status, and visually verify calendar layout.

Purpose: Close remaining tech debt from v1.1 audit so the milestone is fully clean.
Output: Updated schema.sql, clean CountryPanel.tsx, accurate REQUIREMENTS.md, user-verified calendar visuals.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-cleanup-verification/17-RESEARCH.md
@supabase/schema.sql
@supabase/rls-policies.sql
@src/components/sidebar/CountryPanel.tsx
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: RLS cleanup, dead code fix, and docs update</name>
  <files>supabase/schema.sql, src/components/sidebar/CountryPanel.tsx, .planning/REQUIREMENTS.md</files>
  <action>
Three changes in this task:

**1. Update schema.sql RLS policies (lines 60-64):**
Replace the two "Allow all" policies for groceries and timers with the guardrail policies from rls-policies.sql. Keep "Allow all" on chores and chore_completions (those have no guardrails).

Replace lines 60-64 with:
```sql
-- Groceries: guardrail policies (max 100 rows on INSERT)
create policy "anon_select_groceries" on groceries for select to anon using (true);
create policy "anon_insert_groceries" on groceries for insert to anon with check ((select count(*) from groceries) < 100);
create policy "anon_update_groceries" on groceries for update to anon using (true) with check (true);
create policy "anon_delete_groceries" on groceries for delete to anon using (true);

-- Timers: guardrail policies (max 10 active timers on INSERT)
create policy "anon_select_timers" on timers for select to anon using (true);
create policy "anon_insert_timers" on timers for insert to anon with check ((select count(*) from timers where cancelled = false) < 10);
create policy "anon_update_timers" on timers for update to anon using (true) with check (true);
create policy "anon_delete_timers" on timers for delete to anon using (true);

-- Chores and completions: full access (no guardrails needed)
create policy "Allow all" on chores for all using (true) with check (true);
create policy "Allow all" on chore_completions for all using (true) with check (true);
```

Update the comment above the policies section to explain the guardrail pattern. Remove the old "Allow all operations via anon key" comment.

**2. Fix CountryPanel.tsx UnsplashAttribution dead prop:**
- Remove `unsplashUrl: string;` from the UnsplashAttribution props type (line 12)
- Remove `unsplashUrl={countryImage.unsplashUrl}` from the caller (line 123)

**3. Update REQUIREMENTS.md:**
- Check the SIRI-02 checkbox: change `- [ ] **SIRI-02**` to `- [x] **SIRI-02**`
- In the Traceability table, change SIRI-02 status from `Pending` to `Satisfied`
- Update the Coverage summary: change "Satisfied: 9" to "Satisfied: 10", remove the "Pending (gap closure): 1" line

**Also print the SQL the user needs to run in Supabase Dashboard.** Output this clearly so the user can copy-paste it:

```
=== RUN THIS IN SUPABASE SQL EDITOR ===

-- Step 1: Verify guardrail policies exist
SELECT tablename, policyname, cmd
FROM pg_policies
WHERE tablename IN ('groceries', 'timers')
ORDER BY tablename, policyname;

-- You should see anon_select/insert/update/delete for both tables.
-- If you do NOT see them, stop and do not proceed.

-- Step 2: Drop conflicting "Allow all" policies
BEGIN;
DROP POLICY IF EXISTS "Allow all" ON groceries;
DROP POLICY IF EXISTS "Allow all" ON timers;
COMMIT;

-- Step 3: Verify cleanup
SELECT tablename, policyname, cmd
FROM pg_policies
WHERE tablename IN ('groceries', 'timers')
ORDER BY tablename, policyname;

-- Should show only anon_* policies (4 per table, 8 total)
```
  </action>
  <verify>
- `npx tsc --noEmit` passes (no TypeScript errors from CountryPanel change)
- schema.sql contains "anon_select_groceries" and "anon_insert_groceries" (not "Allow all" for groceries/timers)
- schema.sql still contains "Allow all" for chores and chore_completions
- REQUIREMENTS.md shows `[x] **SIRI-02**` and traceability table shows "Satisfied" for SIRI-02
- SQL instructions printed for user to run in Supabase Dashboard
  </verify>
  <done>
schema.sql reflects guardrail policies for groceries/timers, CountryPanel has no dead props, REQUIREMENTS.md is fully up to date, and user has SQL to run in Supabase Dashboard.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify RLS cleanup and calendar visuals</name>
  <files>supabase/schema.sql</files>
  <action>
User verifies two things: (1) RLS cleanup in live Supabase, and (2) calendar visual layout on the dashboard.
  </action>
  <verify>
User confirms both RLS cleanup and calendar visuals are correct.
  </verify>
  <done>
RLS policies cleaned up in live Supabase, calendar emojis and weather layout confirmed correct.
  </done>
  <what-built>
Task 1 updated schema.sql, fixed CountryPanel dead prop, and updated REQUIREMENTS.md. It also printed SQL for you to run in Supabase Dashboard to drop the conflicting "Allow all" RLS policies.
  </what-built>
  <how-to-verify>
**RLS Cleanup (Supabase Dashboard):**
1. Go to Supabase Dashboard > SQL Editor
2. Run the SQL printed by Task 1 (verify, drop, verify)
3. Confirm only anon_* policies remain on groceries and timers tables
4. Test: add a grocery item from the dashboard -- it should still work

**Calendar Visual Verification (FIX-02, CALL-01, CALL-02):**
1. Open the wall dashboard (or http://localhost:5173)
2. Look at the calendar section
3. Verify: each event has a person emoji before the event name (avocado for Papa, cookie for Daddy, cherry blossom for Wren, mango for Ellis, house for Family)
4. Verify: weather info (temperature, icon) sits underneath the day header row, not inline with events
5. Verify: the layout looks correct on the wall display

**CountryPanel:**
6. Look at the Country of the Day panel -- confirm the photo and attribution still display correctly
  </how-to-verify>
  <resume-signal>Type "approved" if everything looks correct, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
- schema.sql has guardrail policies for groceries/timers (not "Allow all")
- CountryPanel.tsx UnsplashAttribution has exactly 2 props (photographer, photographerUrl)
- REQUIREMENTS.md shows 10/10 v1.1 requirements satisfied
- User confirmed RLS policies dropped in live Supabase
- User confirmed calendar emojis and weather layout are correct
</verification>

<success_criteria>
1. Supabase live database has only anon_* policies on groceries and timers (user-verified)
2. schema.sql matches production RLS state
3. CountryPanel.tsx has no unused props
4. REQUIREMENTS.md shows all v1.1 requirements as Satisfied
5. Calendar person emojis and weather-under-header layout visually confirmed by user
</success_criteria>

<output>
After completion, create `.planning/phases/17-cleanup-verification/17-01-SUMMARY.md`
</output>
