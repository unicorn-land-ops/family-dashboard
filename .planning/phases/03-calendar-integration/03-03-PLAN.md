---
phase: 03-calendar-integration
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/hooks/useCalendar.ts
  - src/components/calendar/CalendarPanel.tsx
  - src/components/calendar/DayRow.tsx
  - src/components/calendar/EventCard.tsx
  - src/components/calendar/WeatherBadge.tsx
  - src/App.tsx
  - src/index.css
autonomous: true
requirements: [CAL-01, CAL-02, CAL-05, CAL-07, CLKW-03]

must_haves:
  truths:
    - "Calendar panel displays 7 days of events grouped by day"
    - "Each event shows person emoji badges for who it applies to"
    - "Each day row shows hi/lo temperature and weather icon from useWeather"
    - "Schulfrei/No School events display with visual highlight (accent color)"
    - "Traveling family members show dual timezone on their events"
    - "All-day events appear at top of each day, before timed events"
    - "Calendar replaces the placeholder card in main content area"
    - "Loading and error states display gracefully"
  artifacts:
    - path: "src/hooks/useCalendar.ts"
      provides: "Orchestrates parallel feed fetch, parse, dedup, filter, group by day"
      exports: ["useCalendar"]
    - path: "src/components/calendar/CalendarPanel.tsx"
      provides: "Main calendar container rendering 7 DayRow components"
      contains: "CalendarPanel"
    - path: "src/components/calendar/DayRow.tsx"
      provides: "Single day: date header + WeatherBadge + event list"
      contains: "DayRow"
    - path: "src/components/calendar/EventCard.tsx"
      provides: "Individual event with person badges and dual timezone"
      contains: "EventCard"
    - path: "src/components/calendar/WeatherBadge.tsx"
      provides: "Compact hi/lo temp + weather icon for day header"
      contains: "WeatherBadge"
  key_links:
    - from: "src/hooks/useCalendar.ts"
      to: "src/lib/calendar/parser.ts"
      via: "parseICS call for each feed"
      pattern: "parseICS"
    - from: "src/hooks/useCalendar.ts"
      to: "@tanstack/react-query"
      via: "useQueries for parallel fetching"
      pattern: "useQueries"
    - from: "src/components/calendar/DayRow.tsx"
      to: "src/hooks/useWeather.ts"
      via: "weather data for day header"
      pattern: "useWeather"
    - from: "src/components/calendar/EventCard.tsx"
      to: "src/lib/calendar/config.ts"
      via: "travelTimezone lookup for dual display"
      pattern: "travelTimezone"
    - from: "src/App.tsx"
      to: "src/components/calendar/CalendarPanel.tsx"
      via: "replaces Calendar placeholder"
      pattern: "CalendarPanel"
---

<objective>
Build the useCalendar hook and all calendar UI components, then wire CalendarPanel into the main content area of App.tsx.

Purpose: This is the user-facing result of the calendar integration — transforming raw calendar data into a beautiful 7-day schedule with weather forecasts, person badges, and intelligent event display.
Output: Working calendar panel showing 7 days of family events with weather integration
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calendar-integration/03-RESEARCH.md
@.planning/phases/03-calendar-integration/03-01-SUMMARY.md
@.planning/phases/02-clock-weather-core/02-01-SUMMARY.md
@src/hooks/useWeather.ts
@src/lib/api/openMeteo.ts
@src/App.tsx
@src/index.css
@src/components/layout/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCalendar hook with parallel fetching and day grouping</name>
  <files>
    src/hooks/useCalendar.ts
  </files>
  <action>
    Create `src/hooks/useCalendar.ts`:

    1. Import useQueries from @tanstack/react-query, useMemo from react
    2. Import CALENDAR_FEEDS from lib/calendar/config
    3. Import fetchCalendarFeed from lib/api/calendarFetch
    4. Import parseICS from lib/calendar/parser
    5. Import deduplicateEvents from lib/calendar/dedup
    6. Import applyFilters from lib/calendar/filters
    7. Import DaySchedule, CalendarEvent from lib/calendar/types
    8. Import startOfToday, addDays, format, isSameDay from date-fns

    Export function useCalendar() that:
    - Uses useQueries to fetch all 5 feeds in parallel:
      - queryKey: ['calendar', feed.id]
      - queryFn: () => fetchCalendarFeed(feed.calendarUrl)
      - staleTime: 5 * 60 * 1000 (5 min stale)
      - refetchInterval: 15 * 60 * 1000 (15 min auto-refresh)
      - retry: 3
      - enabled: !!feed.calendarUrl (skip feeds with missing env var — graceful degradation)
    - In useMemo, when queries have data:
      - Flatten: for each successful query result + corresponding feed, call parseICS(data, feed)
      - Deduplicate: deduplicateEvents(allEvents)
      - Filter: applyFilters(deduped)
      - Group by day: create 7 DaySchedule objects (today + 6 days)
        - For each day, filter events where isSameDay(event.startTime, day) OR (isAllDay and event spans the day)
        - Sort events within each day: all-day events first, then by startTime ascending
        - Set dateStr to format(date, 'yyyy-MM-dd')
    - Return { days: DaySchedule[], isLoading, isError, errors }
    - isLoading = any query still loading AND no data yet
    - isError = any query errored (but others may still show data — partial success is fine)

    Handle edge case: if CORS proxy is not configured (VITE_CORS_PROXY_URL missing), all queries will fail gracefully and show error state.
  </action>
  <verify>
    - `npm run build` succeeds
    - `grep "useQueries" src/hooks/useCalendar.ts` shows parallel fetching
    - `grep "deduplicateEvents" src/hooks/useCalendar.ts` shows dedup integration
    - `grep "applyFilters" src/hooks/useCalendar.ts` shows filter integration
  </verify>
  <done>
    useCalendar hook fetches 5 feeds in parallel, parses with ical-expander, deduplicates, filters, and returns 7 DaySchedule objects sorted and grouped. Handles partial failures gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create calendar UI components and wire into App.tsx</name>
  <files>
    src/components/calendar/WeatherBadge.tsx
    src/components/calendar/EventCard.tsx
    src/components/calendar/DayRow.tsx
    src/components/calendar/CalendarPanel.tsx
    src/App.tsx
    src/index.css
  </files>
  <action>
    1. Create `src/components/calendar/WeatherBadge.tsx`:
       - Props: high (number), low (number), weatherCode (number)
       - Display: weather icon (use WeatherIcon from weather/WeatherIcon.tsx) + hi/lo temps
       - Compact horizontal layout: icon + "H°/L°" format, e.g. "☀️ 12°/5°"
       - Use text-text-secondary for muted styling, small text size
       - Wrap in React.memo

    2. Create `src/components/calendar/EventCard.tsx`:
       - Props: event (CalendarEvent)
       - Import formatInTimeZone from date-fns-tz
       - Import CALENDAR_FEEDS, HOME_TIMEZONE from lib/calendar/config
       - Display: time + summary + person emoji badges
       - For timed events: show time in HH:mm format (Berlin timezone)
       - For all-day events: no time, just summary
       - Person badges: for each person ID in event.persons, look up emoji from CALENDAR_FEEDS, display as small badges
       - Schulfrei highlight: if event.isSchulfrei, apply accent-gold background/border styling to make it visually prominent
       - Dual timezone: if any person in event.persons has travelTimezone set in CALENDAR_FEEDS, show both times: "14:00 / 08:00 NYC" format
       - Compact design — this will be inside a scrollable panel showing many events
       - Use card-glass styling or subtle background for each event

    3. Create `src/components/calendar/DayRow.tsx`:
       - Props: day (DaySchedule), dayIndex (number, 0-6 for weather array mapping)
       - Import useWeather from hooks/useWeather
       - Date header: show day name + date (e.g., "Monday, Feb 17") using date-fns format
       - Today: bold/highlighted header, "Today" label
       - Weather: if useWeather has data and dayIndex < daily array length, render WeatherBadge with hi/lo/code
       - Events: render EventCard for each event in day.events
       - Empty day: show subtle "No events" text
       - Separator between days (subtle border or spacing)

    4. Create `src/components/calendar/CalendarPanel.tsx`:
       - Import useCalendar from hooks/useCalendar
       - Loading state: show skeleton/spinner while calendar loads
       - Error state: show friendly error message (not raw error text)
       - Success state: render DayRow for each of the 7 days
       - Scrollable container (overflow-y-auto) — 7 days of events may exceed viewport
       - Apply card-glass styling to the outer container to match dashboard aesthetic

    5. Update `src/App.tsx`:
       - Import CalendarPanel from components/calendar/CalendarPanel
       - Replace the Calendar placeholder div with CalendarPanel
       - Keep the card-glass wrapper or let CalendarPanel handle its own styling (CalendarPanel should be self-contained)

    6. Update `src/index.css` — add calendar-specific utility classes:
       - .event-schulfrei: accent-gold border-left or background tint for Schulfrei events
       - .day-today: slightly brighter background for today's row
       - Keep consistent with existing glass-morphism theme
  </action>
  <verify>
    - `npm run build` succeeds with zero errors
    - `ls src/components/calendar/CalendarPanel.tsx src/components/calendar/DayRow.tsx src/components/calendar/EventCard.tsx src/components/calendar/WeatherBadge.tsx` all exist
    - `grep "CalendarPanel" src/App.tsx` shows it's wired in
    - `grep "useCalendar" src/components/calendar/CalendarPanel.tsx` shows hook usage
    - `grep "useWeather" src/components/calendar/DayRow.tsx` shows weather integration
    - `grep "travelTimezone" src/components/calendar/EventCard.tsx` shows dual timezone support
    - `grep "isSchulfrei" src/components/calendar/EventCard.tsx` shows highlight logic
    - `npm run dev` starts without errors (calendar will show loading/error state without .env configured, which is expected)
  </verify>
  <done>
    Complete calendar UI: CalendarPanel shows 7 days with weather badges, person emoji tags, Schulfrei highlights, dual timezone for travelers, and graceful loading/error states. Calendar placeholder in App.tsx replaced with working CalendarPanel.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero errors
- All 5 new component files + 1 hook file exist
- App.tsx imports and renders CalendarPanel (no more Calendar placeholder)
- Weather data integrates into day row headers via useWeather hook
- Person badges render for each event using emoji from config
- Schulfrei events have visual highlight styling
- Dual timezone displays when travelTimezone is set in config
- Dev server starts and shows calendar UI (loading state without .env is acceptable)
</verification>

<success_criteria>
Working calendar UI visible in the dashboard's main content area. 7-day schedule with weather forecasts per day, person emoji badges, Schulfrei highlights, and dual-timezone support. Replaces the Calendar placeholder. Graceful handling of missing env vars (shows loading/error rather than crashing).
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar-integration/03-03-SUMMARY.md`
</output>
