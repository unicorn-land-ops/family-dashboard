---
phase: 03-calendar-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/calendar/types.ts
  - src/lib/calendar/config.ts
  - src/lib/calendar/parser.ts
  - src/lib/calendar/dedup.ts
  - src/lib/calendar/filters.ts
  - src/lib/api/calendarFetch.ts
  - src/types/ical-expander.d.ts
  - package.json
autonomous: true
requirements: [CAL-01, CAL-02, CAL-03, CAL-04, CAL-05, CAL-06, CAL-07]

must_haves:
  truths:
    - "ICS text can be parsed into typed CalendarEvent objects with person tags"
    - "Recurring events expand correctly for a 7-day window using ical-expander"
    - "Duplicate events across calendars merge person tags instead of showing twice"
    - "Papa's work-hours events (9-18 weekdays) are filtered out"
    - "Schulfrei/No School all-day events are flagged for highlighting"
    - "Travel timezone config is available per person for dual-timezone display"
  artifacts:
    - path: "src/lib/calendar/types.ts"
      provides: "CalendarEvent, DaySchedule, PersonConfig types"
      contains: "interface CalendarEvent"
    - path: "src/lib/calendar/config.ts"
      provides: "Feed configuration with env vars and person metadata"
      contains: "CALENDAR_FEEDS"
    - path: "src/lib/calendar/parser.ts"
      provides: "ICS text to CalendarEvent[] conversion with ical-expander"
      contains: "parseICS"
    - path: "src/lib/calendar/dedup.ts"
      provides: "Cross-calendar event deduplication with person merge"
      contains: "deduplicateEvents"
    - path: "src/lib/calendar/filters.ts"
      provides: "Work-hours filter and Schulfrei detection"
      contains: "applyFilters"
    - path: "src/lib/api/calendarFetch.ts"
      provides: "CORS-proxied ICS fetch"
      contains: "fetchCalendarFeed"
    - path: "src/types/ical-expander.d.ts"
      provides: "TypeScript declarations for ical-expander module"
      contains: "declare module"
  key_links:
    - from: "src/lib/calendar/parser.ts"
      to: "ical-expander"
      via: "import and .between() call"
      pattern: "IcalExpander.*between"
    - from: "src/lib/calendar/config.ts"
      to: ".env"
      via: "import.meta.env.VITE_CAL_*"
      pattern: "import\\.meta\\.env\\.VITE_CAL"
    - from: "src/lib/calendar/filters.ts"
      to: "src/lib/calendar/config.ts"
      via: "isWorkCalendar flag lookup"
      pattern: "isWorkCalendar"
---

<objective>
Build the complete calendar data layer: types, config, ICS parser with recurring event expansion, cross-calendar deduplication, and smart filtering (work-hours, Schulfrei detection).

Purpose: Establish all calendar logic as pure, testable functions before building UI. This separates concerns cleanly ‚Äî the UI plan only needs to consume typed data.
Output: 7 source files forming the calendar data pipeline: fetch -> parse -> dedup -> filter
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calendar-integration/03-RESEARCH.md
@src/lib/api/openMeteo.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ical-expander and create types, config, and type declarations</name>
  <files>
    package.json
    src/lib/calendar/types.ts
    src/lib/calendar/config.ts
    src/types/ical-expander.d.ts
  </files>
  <action>
    1. Install ical-expander: `npm install ical-expander`
       Do NOT install ical.js separately ‚Äî let ical-expander bring its own v1 dependency.

    2. Create `src/types/ical-expander.d.ts` ‚Äî minimal TypeScript declarations for the subset of ical-expander API we use:
       - Default export class IcalExpander with constructor({ics: string, maxIterations?: number})
       - .between(after: Date, before: Date) returning { events: ICalEvent[], occurrences: ICalOccurrence[] }
       - ICalEvent shape: uid, summary, startDate (with toJSDate(), isDate), endDate (with toJSDate()), location
       - ICalOccurrence shape: item (ICalEvent), startDate, endDate

    3. Create `src/lib/calendar/types.ts`:
       - CalendarEvent interface: id, summary, startTime (Date), endTime (Date), isAllDay (boolean), persons (string[]), location (string | undefined), isSchulfrei (boolean, optional, added by filter pass)
       - DaySchedule interface: date (Date), dateStr (string, 'YYYY-MM-DD'), events (CalendarEvent[]), weather (optional: { high: number, low: number, weatherCode: number })
       - PersonConfig interface: id, name, emoji, calendarUrl (string), isWorkCalendar (boolean, optional), travelTimezone (string | undefined, optional ‚Äî set when person is traveling, e.g. 'America/New_York')
       - Re-export PersonConfig from types so config.ts can import it

    4. Create `src/lib/calendar/config.ts`:
       - Import PersonConfig from types.ts
       - Export CALENDAR_FEEDS array of PersonConfig with 5 entries:
         - papa: emoji 'üë®', calendarUrl from import.meta.env.VITE_CAL_PAPA, isWorkCalendar: true
         - daddy: emoji 'üë®‚Äçü¶∞', calendarUrl from import.meta.env.VITE_CAL_DADDY
         - wren: emoji 'ü¶Ö', calendarUrl from import.meta.env.VITE_CAL_WREN
         - ellis: emoji 'üåü', calendarUrl from import.meta.env.VITE_CAL_ELLIS
         - family: emoji 'üë®‚Äçüë®‚Äçüëß‚Äçüë¶', calendarUrl from import.meta.env.VITE_CAL_FAMILY
       - Export CORS_PROXY_URL from import.meta.env.VITE_CORS_PROXY_URL
       - Export HOME_TIMEZONE = 'Europe/Berlin'
       - Note: travelTimezone is undefined by default; set via env var or config when someone travels

    5. Add .env to .gitignore if not already present. Create .env.example with all VITE_CAL_* and VITE_CORS_PROXY_URL keys (empty values) so contributors know what's needed.
  </action>
  <verify>
    - `npm run build` succeeds (TypeScript compiles with new types)
    - `ls src/lib/calendar/types.ts src/lib/calendar/config.ts src/types/ical-expander.d.ts` all exist
    - `grep "ical-expander" package.json` shows dependency
  </verify>
  <done>
    ical-expander installed, CalendarEvent/DaySchedule/PersonConfig types defined, 5-feed config with env vars, ical-expander type declarations in place, .env.example documents required secrets
  </done>
</task>

<task type="auto">
  <name>Task 2: Create parser, dedup, filters, and fetch client</name>
  <files>
    src/lib/calendar/parser.ts
    src/lib/calendar/dedup.ts
    src/lib/calendar/filters.ts
    src/lib/api/calendarFetch.ts
  </files>
  <action>
    1. Create `src/lib/api/calendarFetch.ts`:
       - Import CORS_PROXY_URL from calendar/config
       - Export async function fetchCalendarFeed(calendarUrl: string): Promise&lt;string&gt;
       - Build proxy URL: `${CORS_PROXY_URL}?url=${encodeURIComponent(calendarUrl)}`
       - Fetch with error handling (throw on non-ok response)
       - Return response.text() (ICS is plain text)
       - If CORS_PROXY_URL is not set, throw a clear error: "VITE_CORS_PROXY_URL not configured"

    2. Create `src/lib/calendar/parser.ts`:
       - Import IcalExpander from 'ical-expander' (default import ‚Äî Vite handles CJS interop)
       - Import startOfToday, addDays from 'date-fns'
       - Import PersonConfig, CalendarEvent from ./types
       - Export function parseICS(icsText: string, feed: PersonConfig): CalendarEvent[]
       - Create IcalExpander instance with { ics: icsText, maxIterations: 1000 }
       - Call .between(startOfToday(), addDays(startOfToday(), 7))
       - Map events to CalendarEvent: use event.uid as id, event.summary, event.startDate.toJSDate(), event.endDate.toJSDate(), event.startDate.isDate for isAllDay, [feed.id] for persons, event.location
       - Map occurrences to CalendarEvent: use `${occ.item.uid}-${occ.startDate.toJSDate().toISOString()}` as id to make each occurrence unique
       - Return combined array
       - IMPORTANT: Always use .between() with 7-day window, NEVER use .all() (infinite RRULE risk per research pitfall 3)

    3. Create `src/lib/calendar/dedup.ts`:
       - Import CalendarEvent from ./types
       - Export function deduplicateEvents(events: CalendarEvent[]): CalendarEvent[]
       - Create normalized key: `${summary.trim().toLowerCase()}|${startTime.toISOString()}|${endTime.toISOString()}`
       - Use Map&lt;string, CalendarEvent&gt; to track seen events
       - When duplicate found, MERGE persons arrays (union via Set) ‚Äî this is key for showing multiple person badges on shared events
       - Return Array.from(map.values())

    4. Create `src/lib/calendar/filters.ts`:
       - Import getDay, getHours from 'date-fns'
       - Import CalendarEvent from ./types, CALENDAR_FEEDS from ./config
       - Internal function isWorkHoursEvent(event): boolean ‚Äî returns true if NOT all-day, weekday (Mon-Fri, getDay 1-5), and start hour between 9-17 (inclusive, meaning starts 9-17)
       - Internal function isSchulfrei(event): boolean ‚Äî returns true if all-day AND summary matches /schulfrei|no school|kein unterricht/i
       - Export function applyFilters(events: CalendarEvent[]): CalendarEvent[]
         - Find Papa's feed by isWorkCalendar flag
         - Filter OUT events where: event includes Papa's person ID AND isWorkHoursEvent is true AND event.persons has ONLY Papa (if shared with others, keep it)
         - Map remaining events to add isSchulfrei: isSchulfrei(event)
         - Return filtered+mapped array
  </action>
  <verify>
    - `npm run build` succeeds with zero TypeScript errors
    - `ls src/lib/calendar/parser.ts src/lib/calendar/dedup.ts src/lib/calendar/filters.ts src/lib/api/calendarFetch.ts` all exist
    - Each file exports the expected function (grep for export function in each)
  </verify>
  <done>
    Complete data pipeline: fetchCalendarFeed fetches ICS via CORS proxy, parseICS expands recurring events with ical-expander, deduplicateEvents merges cross-calendar duplicates with person tag union, applyFilters removes Papa's work events and flags Schulfrei days
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero errors
- All 7 new source files exist in correct locations
- ical-expander appears in package.json dependencies
- .env.example documents all required environment variables
- No calendar URLs committed to source (grep for calendar.google.com in src/)
</verification>

<success_criteria>
Calendar data pipeline compiles and is ready for consumption by useCalendar hook and UI components. Types are shared across all calendar modules. Config uses env vars for secrets. Parser handles both single and recurring events. Dedup merges person tags. Filters handle work-hours and Schulfrei detection.
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar-integration/03-01-SUMMARY.md`
</output>
