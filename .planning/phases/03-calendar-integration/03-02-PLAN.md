---
phase: 03-calendar-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - cloudflare-worker/cors-proxy.js
  - cloudflare-worker/wrangler.toml
autonomous: false
requirements: [CAL-01]

must_haves:
  truths:
    - "CORS proxy worker code exists and is ready for deployment"
    - "Worker only allows Google Calendar URLs (security restriction)"
    - "Worker adds CORS headers and caches responses for 5 minutes"
  artifacts:
    - path: "cloudflare-worker/cors-proxy.js"
      provides: "Cloudflare Worker CORS proxy for Google Calendar ICS feeds"
      contains: "calendar.google.com"
    - path: "cloudflare-worker/wrangler.toml"
      provides: "Cloudflare Worker deployment configuration"
      contains: "name"
  key_links:
    - from: "cloudflare-worker/cors-proxy.js"
      to: "Google Calendar"
      via: "fetch proxy with CORS headers"
      pattern: "Access-Control-Allow-Origin"

user_setup:
  - service: cloudflare-workers
    why: "CORS proxy for Google Calendar iCal feeds — browser cannot fetch calendar.google.com directly due to missing CORS headers"
    env_vars:
      - name: VITE_CORS_PROXY_URL
        source: "Cloudflare Workers dashboard after deployment — the worker URL (e.g., https://cal-proxy.your-subdomain.workers.dev)"
    dashboard_config:
      - task: "Create Cloudflare account (if needed) and deploy worker"
        location: "https://dash.cloudflare.com -> Workers & Pages -> Create -> Deploy a Hello World script, then replace code with cors-proxy.js content"
  - service: google-calendar
    why: "Private iCal feed URLs for 5 family calendars"
    env_vars:
      - name: VITE_CAL_PAPA
        source: "Google Calendar -> Papa's calendar -> Settings -> Secret address in iCal format"
      - name: VITE_CAL_DADDY
        source: "Google Calendar -> Daddy's calendar -> Settings -> Secret address in iCal format"
      - name: VITE_CAL_WREN
        source: "Google Calendar -> Wren's calendar -> Settings -> Secret address in iCal format"
      - name: VITE_CAL_ELLIS
        source: "Google Calendar -> Ellis's calendar -> Settings -> Secret address in iCal format"
      - name: VITE_CAL_FAMILY
        source: "Google Calendar -> Family calendar -> Settings -> Secret address in iCal format"
---

<objective>
Create the Cloudflare Worker CORS proxy code and deployment config, then checkpoint for human deployment.

Purpose: Google Calendar iCal feeds do not include CORS headers, so browser-side fetch fails. A lightweight Cloudflare Worker (free tier: 100K req/day) proxies requests and adds the necessary headers. This MUST be deployed before calendar data can load in the dashboard.
Output: Deployable worker code + wrangler config in cloudflare-worker/ directory
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-calendar-integration/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare Worker CORS proxy code and wrangler config</name>
  <files>
    cloudflare-worker/cors-proxy.js
    cloudflare-worker/wrangler.toml
  </files>
  <action>
    1. Create `cloudflare-worker/cors-proxy.js`:
       - Export default fetch handler
       - Extract `url` query parameter from request URL
       - Return 400 if `url` param is missing
       - Security: Only allow URLs starting with `https://calendar.google.com/` — return 403 for all others
       - Handle OPTIONS preflight requests (return 204 with CORS headers)
       - Fetch the target URL
       - Return response body with headers:
         - Access-Control-Allow-Origin: *
         - Access-Control-Allow-Methods: GET, OPTIONS
         - Access-Control-Allow-Headers: Content-Type
         - Content-Type: text/calendar
         - Cache-Control: public, max-age=300 (5-minute edge cache)

    2. Create `cloudflare-worker/wrangler.toml`:
       - name = "family-cal-proxy"
       - main = "cors-proxy.js"
       - compatibility_date = "2024-01-01"
       - No additional bindings needed (worker is stateless)

    3. Add a brief README comment at the top of cors-proxy.js explaining:
       - What it does (CORS proxy for Google Calendar ICS feeds)
       - How to deploy: `cd cloudflare-worker && npx wrangler deploy`
       - Free tier limit: 100K requests/day
  </action>
  <verify>
    - `ls cloudflare-worker/cors-proxy.js cloudflare-worker/wrangler.toml` both exist
    - `grep "calendar.google.com" cloudflare-worker/cors-proxy.js` shows security check
    - `grep "Access-Control-Allow-Origin" cloudflare-worker/cors-proxy.js` shows CORS header
  </verify>
  <done>
    Worker code ready for deployment. Security restricts to Google Calendar URLs only. CORS headers and 5-minute edge caching configured.
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <name>Task 2: Deploy CORS proxy and configure calendar env vars</name>
  <what-built>
    Cloudflare Worker CORS proxy code in cloudflare-worker/ directory, ready for deployment.
    Also need Google Calendar secret iCal URLs for all 5 family calendars.
  </what-built>
  <how-to-verify>
    **Deploy the CORS proxy (one-time setup):**
    1. If you don't have a Cloudflare account, create one at https://dash.cloudflare.com
    2. Deploy: `cd cloudflare-worker && npx wrangler deploy` (will prompt for Cloudflare login)
    3. Note the worker URL (e.g., `https://family-cal-proxy.your-subdomain.workers.dev`)
    4. Test: `curl "https://family-cal-proxy.your-subdomain.workers.dev?url=https://calendar.google.com/calendar/ical/en.usa%23holiday%40group.v.calendar.google.com/public/basic.ics"` — should return ICS text

    **Get Google Calendar iCal URLs:**
    5. For each calendar (Papa, Daddy, Wren, Ellis, Family):
       - Google Calendar -> Settings -> click the calendar name -> "Secret address in iCal format" -> Copy URL

    **Create .env file:**
    6. Create `.env` in project root with:
       ```
       VITE_CORS_PROXY_URL=https://family-cal-proxy.your-subdomain.workers.dev
       VITE_CAL_PAPA=https://calendar.google.com/calendar/ical/...
       VITE_CAL_DADDY=https://calendar.google.com/calendar/ical/...
       VITE_CAL_WREN=https://calendar.google.com/calendar/ical/...
       VITE_CAL_ELLIS=https://calendar.google.com/calendar/ical/...
       VITE_CAL_FAMILY=https://calendar.google.com/calendar/ical/...
       ```
    7. Restart dev server after creating .env: `npm run dev`
  </how-to-verify>
  <resume-signal>Type "deployed" with the worker URL, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- cloudflare-worker/ directory contains cors-proxy.js and wrangler.toml
- Worker code restricts to Google Calendar URLs only
- Worker handles OPTIONS preflight and GET requests with CORS headers
</verification>

<success_criteria>
CORS proxy code exists and is ready for human deployment. After deployment, the dashboard can fetch Google Calendar ICS feeds from the browser.
</success_criteria>

<output>
After completion, create `.planning/phases/03-calendar-integration/03-02-SUMMARY.md`
</output>
