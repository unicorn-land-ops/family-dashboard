---
phase: 04-transit-fun-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/api/bvgTransit.ts
  - src/lib/api/horoscope.ts
  - src/lib/api/countryOfDay.ts
  - src/hooks/useTransit.ts
  - src/hooks/useHoroscope.ts
  - src/hooks/useCountryOfDay.ts
  - src/lib/constants.ts
autonomous: true
requirements: [TRNS-01, FUN-01, FUN-02]

must_haves:
  truths:
    - "BVG departure data fetches successfully from transport.rest v6 API"
    - "Horoscope data fetches for Capricorn, Aquarius, Sagittarius"
    - "Country of the Day returns a deterministic country per calendar day (Berlin timezone)"
    - "All three data sources cache appropriately and auto-refetch"
  artifacts:
    - path: "src/lib/api/bvgTransit.ts"
      provides: "BVG departures fetch with typed response"
      exports: ["fetchDepartures", "Departure"]
    - path: "src/lib/api/horoscope.ts"
      provides: "Horoscope fetch for 3 family signs"
      exports: ["fetchHoroscopes", "HoroscopeData", "FAMILY_SIGNS"]
    - path: "src/lib/api/countryOfDay.ts"
      provides: "Country of the Day fetch with day-seeded selection"
      exports: ["fetchCountryOfDay", "CountryData"]
    - path: "src/hooks/useTransit.ts"
      provides: "React Query hook for BVG departures"
      exports: ["useTransit"]
    - path: "src/hooks/useHoroscope.ts"
      provides: "React Query hook for horoscopes"
      exports: ["useHoroscope"]
    - path: "src/hooks/useCountryOfDay.ts"
      provides: "React Query hook for country of the day"
      exports: ["useCountryOfDay"]
  key_links:
    - from: "src/hooks/useTransit.ts"
      to: "src/lib/api/bvgTransit.ts"
      via: "queryFn: fetchDepartures"
      pattern: "queryFn.*fetchDepartures"
    - from: "src/hooks/useHoroscope.ts"
      to: "src/lib/api/horoscope.ts"
      via: "queryFn: fetchHoroscopes"
      pattern: "queryFn.*fetchHoroscopes"
    - from: "src/hooks/useCountryOfDay.ts"
      to: "src/lib/api/countryOfDay.ts"
      via: "queryFn: fetchCountryOfDay"
      pattern: "queryFn.*fetchCountryOfDay"
---

<objective>
Create the API data layer for all three Phase 4 content sources: BVG transit departures, daily horoscopes, and Country of the Day.

Purpose: Establishes typed fetch functions and React Query hooks matching existing project patterns (see useWeather/openMeteo). All three APIs are free, CORS-enabled, and need no proxy.
Output: 6 new files (3 API modules + 3 hooks) plus updated constants.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-transit-fun-content/04-RESEARCH.md
@src/lib/api/openMeteo.ts
@src/hooks/useWeather.ts
@src/hooks/useInterval.ts
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BVG transit, horoscope, and country API fetch modules</name>
  <files>src/lib/api/bvgTransit.ts, src/lib/api/horoscope.ts, src/lib/api/countryOfDay.ts</files>
  <action>
Create three API fetch modules following the exact pattern in src/lib/api/openMeteo.ts (typed response interface, async fetch function, error handling).

**src/lib/api/bvgTransit.ts:**
- Base URL: `https://v6.bvg.transport.rest`
- Stop ID: `900110005` (Senefelderplatz)
- Endpoint: `/stops/${STOP_ID}/departures?duration=30&results=10`
- Do NOT filter by subway=true only -- include bus results too since U2 has replacement bus services (SEV/Ersatzverkehr) during construction through Oct 2026
- Export `Departure` interface with fields: tripId, direction, line (name, product), when (string|null -- null means cancelled), plannedWhen (string), delay (number|null -- in SECONDS not minutes), platform (string|null), remarks (array of {type, text})
- Export `fetchDepartures(): Promise<Departure[]>` that fetches and returns `data.departures`
- Handle non-ok response with descriptive error

**src/lib/api/horoscope.ts:**
- Base URL: `https://ohmanda.com/api/horoscope`
- Export `FAMILY_SIGNS = ['capricorn', 'aquarius', 'sagittarius'] as const`
- Export `SIGN_LABELS` map: capricorn -> "Papa (Capricorn)", aquarius -> "Daddy (Aquarius)", sagittarius -> "Wren (Sagittarius)"
- Export `HoroscopeData` interface: { sign: string; date: string; horoscope: string }
- Export `fetchHoroscopes(): Promise<HoroscopeData[]>` using Promise.all to fetch all 3 signs in parallel
- Wrap each individual fetch in try/catch so one sign failing doesn't break the others (return partial results)

**src/lib/api/countryOfDay.ts:**
- URL: `https://restcountries.com/v3.1/all?fields=name,flags,capital,population,languages,region,currencies`
- Export `CountryData` interface: name ({common, official}), flags ({svg, png, alt}), capital (string[]), population (number), languages (Record<string, string>), region (string), currencies (Record<string, {name, symbol}>)
- Export `pickCountryOfDay(countries: CountryData[]): CountryData` -- uses Berlin-timezone date seed (YYYYMMDD as integer, modulo countries.length) for deterministic daily selection. Import `formatInTimeZone` from date-fns-tz and use `Europe/Berlin` timezone so all devices pick the same country
- Export `fetchCountryOfDay(): Promise<CountryData>` that fetches all countries then calls pickCountryOfDay
  </action>
  <verify>Run `npx tsc --noEmit` -- all three files compile with no type errors. Check that each file exports the documented interfaces and functions.</verify>
  <done>Three API modules exist with typed interfaces, fetch functions handle errors gracefully, BVG includes bus results for construction period, horoscope fetches 3 signs in parallel with partial failure tolerance, country selection is deterministic per Berlin calendar day.</done>
</task>

<task type="auto">
  <name>Task 2: Create React Query hooks and add rotation constants</name>
  <files>src/hooks/useTransit.ts, src/hooks/useHoroscope.ts, src/hooks/useCountryOfDay.ts, src/lib/constants.ts</files>
  <action>
Create three React Query hooks following the exact pattern in src/hooks/useWeather.ts (import fetch function, useQuery with queryKey, queryFn, staleTime, refetchInterval, retry).

**src/hooks/useTransit.ts:**
- queryKey: ['transit', 'senefelderplatz']
- staleTime: 30 * 1000 (30 seconds -- real-time data)
- refetchInterval: 60 * 1000 (every 60 seconds)
- retry: 2

**src/hooks/useHoroscope.ts:**
- queryKey: ['horoscope', 'daily']
- staleTime: 6 * 60 * 60 * 1000 (6 hours -- data changes daily)
- refetchInterval: 6 * 60 * 60 * 1000 (every 6 hours)
- retry: 2

**src/hooks/useCountryOfDay.ts:**
- queryKey: ['country', 'daily']
- staleTime: 24 * 60 * 60 * 1000 (24 hours -- static data, changes at midnight)
- refetchInterval: 24 * 60 * 60 * 1000 (every 24 hours)
- retry: 2

**src/lib/constants.ts** -- add these constants (keep all existing constants unchanged):
```typescript
// Content rotation configuration
export const ROTATION_INTERVAL_MS = 15_000; // 15 seconds per panel
export const ROTATION_PANELS = ['transit', 'horoscopes', 'country'] as const;

// Transit configuration
export const TRANSIT_REFRESH_MS = 60_000; // 60 seconds
export const TRANSIT_STALE_MS = 30_000; // 30 seconds

// Horoscope configuration
export const HOROSCOPE_REFRESH_MS = 6 * 60 * 60 * 1000; // 6 hours

// Country configuration
export const COUNTRY_REFRESH_MS = 24 * 60 * 60 * 1000; // 24 hours
```

Use the constants from constants.ts in the hooks rather than inline numbers.
  </action>
  <verify>Run `npx tsc --noEmit` -- all hook files compile. Run `npm run build` -- full build succeeds with no errors.</verify>
  <done>Three React Query hooks exist matching project patterns. Constants.ts has configurable rotation and refresh intervals. Build passes clean.</done>
</task>

</tasks>

<verification>
- `npm run build` completes with zero errors
- `npx tsc --noEmit` reports no type errors
- All 6 new files exist in correct locations
- constants.ts retains all original constants plus new rotation/refresh values
</verification>

<success_criteria>
- BVG, horoscope, and country fetch functions are typed and handle errors
- React Query hooks match existing useWeather pattern exactly
- Refresh intervals are configurable via constants.ts
- No new dependencies added (React Query, date-fns-tz already in project)
</success_criteria>

<output>
After completion, create `.planning/phases/04-transit-fun-content/04-01-SUMMARY.md`
</output>
