---
phase: 04-transit-fun-content
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/useContentRotation.ts
  - src/components/sidebar/ContentRotator.tsx
  - src/components/sidebar/TransitPanel.tsx
  - src/components/sidebar/HoroscopePanel.tsx
  - src/components/sidebar/CountryPanel.tsx
  - src/components/sidebar/RotationIndicator.tsx
  - src/App.tsx
  - src/index.css
autonomous: true
requirements: [TRNS-01, FUN-01, FUN-02, DISP-04]

must_haves:
  truths:
    - "BVG U2 departures display with line name, direction, time, and delay"
    - "Replacement bus services are visually distinguished from subway departures"
    - "Daily horoscopes display for Papa (Capricorn), Daddy (Aquarius), Wren (Sagittarius)"
    - "Country of the Day shows flag, name, capital, population, languages, region, currency"
    - "Content rotates automatically through transit, horoscopes, country panels"
    - "Smooth crossfade transition between panels"
    - "Rotation indicator dots show current panel and what's next"
    - "Cancelled departures show 'Cancelled' badge instead of crashing"
  artifacts:
    - path: "src/hooks/useContentRotation.ts"
      provides: "Rotation state machine with configurable interval"
      exports: ["useContentRotation"]
    - path: "src/components/sidebar/ContentRotator.tsx"
      provides: "Container with CSS crossfade transitions"
      exports: ["ContentRotator"]
    - path: "src/components/sidebar/TransitPanel.tsx"
      provides: "BVG departure list display"
      exports: ["TransitPanel"]
    - path: "src/components/sidebar/HoroscopePanel.tsx"
      provides: "Daily horoscope cards for 3 signs"
      exports: ["HoroscopePanel"]
    - path: "src/components/sidebar/CountryPanel.tsx"
      provides: "Country of the Day display with flag and facts"
      exports: ["CountryPanel"]
    - path: "src/components/sidebar/RotationIndicator.tsx"
      provides: "Dot indicators for current/next panel"
      exports: ["RotationIndicator"]
  key_links:
    - from: "src/components/sidebar/TransitPanel.tsx"
      to: "src/hooks/useTransit.ts"
      via: "useTransit() hook call"
      pattern: "useTransit\\(\\)"
    - from: "src/components/sidebar/HoroscopePanel.tsx"
      to: "src/hooks/useHoroscope.ts"
      via: "useHoroscope() hook call"
      pattern: "useHoroscope\\(\\)"
    - from: "src/components/sidebar/CountryPanel.tsx"
      to: "src/hooks/useCountryOfDay.ts"
      via: "useCountryOfDay() hook call"
      pattern: "useCountryOfDay\\(\\)"
    - from: "src/App.tsx"
      to: "src/components/sidebar/ContentRotator.tsx"
      via: "ContentRotator replaces sidebar placeholders"
      pattern: "ContentRotator"
    - from: "src/components/sidebar/ContentRotator.tsx"
      to: "src/hooks/useContentRotation.ts"
      via: "useContentRotation() drives panel cycling"
      pattern: "useContentRotation\\(\\)"
---

<objective>
Build the content rotation UI: three display panels (transit, horoscopes, country) wrapped in a crossfade rotator with indicator dots, wired into the sidebar area of App.tsx.

Purpose: Replaces the two placeholder cards in the sidebar with a single rotating content area that cycles through transit departures, daily horoscopes, and country of the day on a configurable timer.
Output: 6 new component/hook files, updated App.tsx and index.css.
</objective>

<execution_context>
@/Users/joshua/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshua/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-transit-fun-content/04-RESEARCH.md
@.planning/phases/04-transit-fun-content/04-01-SUMMARY.md
@src/App.tsx
@src/index.css
@src/lib/constants.ts
@src/hooks/useInterval.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useContentRotation hook and all sidebar panel components</name>
  <files>src/hooks/useContentRotation.ts, src/components/sidebar/TransitPanel.tsx, src/components/sidebar/HoroscopePanel.tsx, src/components/sidebar/CountryPanel.tsx</files>
  <action>
**src/hooks/useContentRotation.ts:**
- Import useInterval from './useInterval' and ROTATION_INTERVAL_MS, ROTATION_PANELS from '../lib/constants'
- State: activeIndex (number), starts at 0
- Uses useInterval to advance activeIndex by 1 (modulo panelCount) every ROTATION_INTERVAL_MS
- Expose goTo(index) callback for manual navigation
- Return { activeIndex, goTo, panelCount: ROTATION_PANELS.length, panels: ROTATION_PANELS }

**src/components/sidebar/TransitPanel.tsx:**
- Call useTransit() hook for departure data
- Show loading skeleton (pulse animation) while loading, error message on failure
- Render header: U-Bahn icon + "Senefelderplatz" title
- Render departure list, each row showing:
  - Line badge (e.g., "U2") with appropriate color -- use yellow/gold for U2. For replacement bus (SEV), use a different color (e.g., blue) and show a bus icon
  - Direction text (truncate if long)
  - Departure time formatted as HH:mm using formatInTimeZone with Europe/Berlin
  - Delay badge: if delay > 0, show "+N min" in red/orange text (delay is in SECONDS, divide by 60 and round)
  - If `when` is null, show "Cancelled" badge in red instead of time
- Visually distinguish replacement bus services: check if line.product === 'bus' OR remarks contain "Ersatzverkehr" -- show bus icon and "SEV" label
- Use Tailwind classes matching card-glass aesthetic (text-text-primary, text-text-secondary, etc.)
- Wrap in React.memo to prevent re-render from rotation state changes

**src/components/sidebar/HoroscopePanel.tsx:**
- Call useHoroscope() hook
- Show loading skeleton while loading, graceful "Horoscopes unavailable" on error
- Render header with star/sparkle icon + "Daily Horoscopes" title
- For each horoscope, render a compact card:
  - Sign label from SIGN_LABELS (e.g., "Papa (Capricorn)") with zodiac emoji (use Unicode: Capricorn \u2651, Aquarius \u2652, Sagittarius \u2650)
  - Horoscope text, truncated to ~3 lines with line-clamp-3 (full text in wall mode is too long, it needs to fit in the sidebar height)
- Use card-glass sub-cards or subtle dividers between signs
- Wrap in React.memo

**src/components/sidebar/CountryPanel.tsx:**
- Call useCountryOfDay() hook
- Show loading skeleton while loading, "Country unavailable" on error
- Render header: globe icon + "Country of the Day" title
- Display:
  - Flag image (use flags.svg from API, with flags.alt as alt text). Make flag large and prominent (h-16 or similar)
  - Country common name in large text, official name in smaller text below if different
  - Facts grid/list: Capital, Population (format with Intl.NumberFormat for commas/dots), Region, Languages (join values), Currency (first currency name + symbol)
- Use compact layout that fits sidebar width (380px)
- Wrap in React.memo
  </action>
  <verify>Run `npx tsc --noEmit` -- all 4 files compile with no type errors.</verify>
  <done>useContentRotation cycles through 3 panels on a timer. TransitPanel shows BVG departures with delay/cancellation/SEV handling. HoroscopePanel shows 3 family horoscopes. CountryPanel shows flag, name, and fact grid.</done>
</task>

<task type="auto">
  <name>Task 2: Create ContentRotator, RotationIndicator, and wire into App.tsx</name>
  <files>src/components/sidebar/ContentRotator.tsx, src/components/sidebar/RotationIndicator.tsx, src/App.tsx, src/index.css</files>
  <action>
**src/components/sidebar/ContentRotator.tsx:**
- Takes children and activeIndex as props
- Renders a relative container (flex-1 overflow-hidden) with all children absolutely positioned
- Each child wrapped in a div with `absolute inset-0 transition-opacity duration-500 ease-in-out`
- Active child: opacity-1, pointerEvents 'auto'. Inactive: opacity-0, pointerEvents 'none'
- IMPORTANT: Keep all panels mounted at all times (do NOT conditionally render). This prevents flash of loading state when rotating back to a panel, since React Query keeps data cached in the mounted hooks
- Also takes onPanelClick callback -- clicking the active panel area is a no-op (non-interactive kiosk display)

**src/components/sidebar/RotationIndicator.tsx:**
- Props: activeIndex, panelCount, labels (string[]), onSelect (index) => void
- Render a row of dots/pills with flex justify-center gap-2
- Active dot: bg-accent-gold, wider (w-6), with the panel label text next to it or as tooltip
- Inactive dots: bg-white/30, w-2 h-2 rounded-full
- Each dot is a button with aria-label set to the panel label (for accessibility)
- Show the label of the NEXT panel in subtle text: "Next: {label}" -- so user knows what's coming
- Transition on dot width/color with duration-300

**src/App.tsx:**
- Remove the two placeholder sidebar cards (the div with "Transit" and "Horoscopes" text)
- Import ContentRotator, TransitPanel, HoroscopePanel, CountryPanel, RotationIndicator, useContentRotation
- In the sidebar area (grid-area-sidebar div), render:
  ```
  <div className="grid-area-sidebar flex flex-col gap-[clamp(10px,1vw,20px)]">
    <ContentRotator activeIndex={activeIndex}>
      <TransitPanel />
      <HoroscopePanel />
      <CountryPanel />
    </ContentRotator>
    <RotationIndicator
      activeIndex={activeIndex}
      panelCount={panelCount}
      labels={['Transit', 'Horoscopes', 'Country']}
      onSelect={goTo}
    />
  </div>
  ```
- The sidebar already has `display: none` in portrait/mobile via index.css -- no changes needed for mobile

**src/index.css:**
- Add a `.panel-transition` utility class for the crossfade if needed (may not be needed if Tailwind transition classes suffice)
- Add `.line-clamp-3` utility if not already available via Tailwind v4 (Tailwind v4 includes line-clamp natively, so test first -- if `line-clamp-3` works out of box, skip this)
- Add a subtle `.departure-cancelled` class with red-tinted background for cancelled departures: `background: rgba(239, 68, 68, 0.1); border-left: 2px solid rgb(239, 68, 68);`
- Add `.departure-sev` class for replacement bus styling: `background: rgba(59, 130, 246, 0.1); border-left: 2px solid rgb(59, 130, 246);`
  </action>
  <verify>Run `npm run build` -- full production build succeeds with zero errors and zero warnings. Verify the sidebar placeholder cards are gone from App.tsx. Verify ContentRotator, all three panels, and RotationIndicator are imported and rendered.</verify>
  <done>Sidebar shows rotating content with smooth crossfade transitions. Transit, horoscopes, and country panels cycle every 15 seconds. Indicator dots show current panel and "Next: X" label. All panels stay mounted for instant display on rotation. Build passes clean.</done>
</task>

</tasks>

<verification>
- `npm run build` completes with zero errors
- App.tsx no longer contains placeholder "Transit" or "Horoscopes" text cards
- ContentRotator wraps all three panels with crossfade transitions
- RotationIndicator shows which panel is active and what's next
- TransitPanel handles cancelled departures (when === null) without crashing
- TransitPanel distinguishes replacement bus services visually
- HoroscopePanel shows all 3 family signs with truncated text
- CountryPanel shows flag, facts, population formatted with commas
- All panels wrapped in React.memo to prevent unnecessary re-renders
</verification>

<success_criteria>
- Content rotates through transit, horoscopes, country every 15 seconds with smooth crossfade
- BVG departures show line, direction, time, delay, cancellation, and SEV handling
- Horoscopes display for Capricorn (Papa), Aquarius (Daddy), Sagittarius (Wren)
- Country shows flag, name, capital, population, languages, region, currency
- Rotation indicator dots show current and next panel
- Rotation interval configurable via ROTATION_INTERVAL_MS in constants.ts
- No new npm dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/04-transit-fun-content/04-02-SUMMARY.md`
</output>
